<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Classic Ludo</title>
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <style>
        :root {
            /* Classic Colors */
            --red: #ea4335;
            --green: #34a853;
            --yellow: #fbbc05;
            --blue: #4285f4;

            --bg-color: #8B4513;
            /* Wood */
            --board-white: #ffffff;
            --border-color: #333;

            /* Token Sizes */
            --token-base-size: 40px;
            --token-board-size: 30px;
            --token-home-size: 25px;
            --token-center-size: 35px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            background-color: var(--bg-color);
            background: #8f0803;
            background: linear-gradient(180deg, rgba(143, 8, 3, 1) 0%, rgba(61, 0, 0, 1) 50%, rgba(173, 23, 0, 1) 100%);
            display: flex;
            flex-direction: column;
            align-items: center;
            height: 100dvh;
            overflow: hidden;
            font-family: 'Segoe UI', system-ui, sans-serif;
        }

        /* --- Header --- */
        .game-ui {
            width: 95%;
            max-width: 500px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 20px;
            margin-top: 10px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(8px);
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.4);
            z-index: 20;
            height: 60px;
            flex-shrink: 0;
        }

        .player-indicator {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 800;
            text-transform: uppercase;
            font-size: 0.9rem;
        }

        .menu-btn {
            padding: 8px;
            border-radius: 50%;
            background: #f1f2f6;
            cursor: pointer;
            border: none;
            transition: 0.2s;
        }

        .menu-btn:active {
            transform: scale(0.9);
        }

        /* --- Board Container (Scaling Wrapper) --- */
        .board-wrapper {
            flex: 1;
            width: 100%;
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
            position: relative;
        }

        /* --- THE BOARD (User Provided Layout) --- */
        .outer {
            height: 750px;
            width: 750px;
            background: var(--board-white);
            border: 5px solid var(--border-color);
            position: relative;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            transform-origin: center center;
            /* Key for scaling */
        }

        /* Layout Blocks */
        .box_row {
            height: 300px;
            width: 750px;
            float: left;
        }

        .middle_row {
            height: 150px;
            width: 750px;
            float: left;
        }

        /* Corner Bases */
        .box {
            height: 300px;
            width: 300px;
            float: left;
            position: relative;
        }

        .box.red-base {
            border: 50px solid var(--red);
        }

        .box.green-base {
            border: 50px solid var(--green);
        }

        .box.blue-base {
            border: 50px solid var(--blue);
        }

        .box.yellow-base {
            border: 50px solid var(--yellow);
        }

        /* Token Circles in Base */
        .circle {
            height: 50px;
            width: 50px;
            margin: 50px;
            border-radius: 50%;
            float: left;
            background: white;
            box-shadow: inset 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .border_red {
            border: 5px solid var(--red);
        }

        .border_green {
            border: 5px solid var(--green);
        }

        .border_blue {
            border: 5px solid var(--blue);
        }

        .border_yellow {
            border: 5px solid var(--yellow);
        }

        /* Vertical Ladder */
        .v_lad {
            height: 300px;
            width: 150px;
            float: left;
        }

        .v_lad_row {
            height: 50px;
            width: 150px;
            float: left;
        }

        .v_lad_cell {
            height: 50px;
            width: 50px;
            border: 1px solid #333;
            float: left;
            text-align: center;
            position: relative;
        }

        /* Horizontal Ladder */
        .h_lad {
            height: 150px;
            width: 300px;
            float: left;
        }

        .h_lad_row {
            height: 50px;
            width: 300px;
            float: left;
        }

        .h_lad_cell {
            height: 50px;
            width: 50px;
            border: 1px solid #333;
            float: left;
            text-align: center;
            position: relative;
        }

        /* Home Center */
        .ludo_home {
            height: 0;
            width: 0;
            border-left: 75px solid var(--red);
            border-right: 75px solid var(--yellow);
            border-top: 75px solid var(--green);
            border-bottom: 75px solid var(--blue);
            float: left;
            position: relative;
            filter: drop-shadow(0 0 10px rgba(0, 0, 0, 0.2));
        }

        /* Trophy Icon in Center */
        .home-icon {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 5;
            color: white;
            width: 40px;
            height: 40px;
        }

        /* Cell Colors */
        .red {
            background: var(--red);
        }

        .green {
            background: var(--green);
        }

        .blue {
            background: var(--blue);
        }

        .yellow {
            background: var(--yellow);
        }

        /* Stars */
        .star {
            font-size: 32px;
            line-height: 46px;
            display: block;
            width: 100%;
            height: 100%;
            color: rgba(0, 0, 0, 0.3);
            text-shadow: 0 1px 0 rgba(255, 255, 255, 0.5);
        }

        /* --- TOKENS --- */
        .tokens-layer {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            z-index: 10;
        }

        .token {
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.4), inset 0 -3px 3px rgba(0, 0, 0, 0.2);
            position: absolute;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            z-index: 100;
            cursor: pointer;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.3);
        }

        /* Token sizes based on location */
        .token.in-base {
            width: var(--token-base-size);
            height: var(--token-base-size);
            font-size: 14px;
            border-width: 3px;
        }

        .token.on-board {
            width: var(--token-board-size);
            height: var(--token-board-size);
            font-size: 12px;
            border-width: 2px;
        }

        .token.in-home-stretch {
            width: var(--token-home-size);
            height: var(--token-home-size);
            font-size: 10px;
            border-width: 2px;
        }

        .token.in-center {
            width: var(--token-center-size);
            height: var(--token-center-size);
            font-size: 13px;
            border-width: 2px;
        }

        .token::after {
            content: '';
            position: absolute;
            top: 20%;
            left: 20%;
            width: 20%;
            height: 20%;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
        }

        .token.red {
            background: radial-gradient(circle at 30% 30%, #ff7675, #c0392b);
        }

        .token.green {
            background: radial-gradient(circle at 30% 30%, #55efc4, #27ae60);
        }

        .token.yellow {
            background: radial-gradient(circle at 30% 30%, #ffeaa7, #f39c12);
        }

        .token.blue {
            background: radial-gradient(circle at 30% 30%, #74b9ff, #2980b9);
        }

        .token.pulse {
            z-index: 200 !important;
            animation: pulse-ring 1s infinite;
        }

        @keyframes pulse-ring {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.2);
            }

            100% {
                transform: scale(1);
            }
        }

        /* Token stacking */
        .token.stacked-2 {
            transform: translate(-5px, -5px) scale(0.9);
        }

        .token.stacked-3 {
            transform: translate(5px, -5px) scale(0.9);
        }

        .token.stacked-4 {
            transform: translate(-5px, 5px) scale(0.9);
        }

        /* --- Footer Controls --- */
        .controls-area {
            width: 100%;
            padding-bottom: max(20px, env(safe-area-inset-bottom));
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
            background: white;
            padding-top: 15px;
            z-index: 30;
            box-shadow: 0 -4px 20px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
            border-top-left-radius: 20px;
            border-top-right-radius: 20px;
        }

        .dice-container {
            width: 64px;
            height: 64px;
            perspective: 600px;
            cursor: pointer;
        }

        .dice {
            width: 100%;
            height: 100%;
            position: relative;
            transform-style: preserve-3d;
            transition: transform 0.6s ease-out;
        }

        .dice.rolling {
            animation: spin 0.5s linear infinite;
        }

        @keyframes spin {
            0% {
                transform: rotateX(0) rotateY(0);
            }

            100% {
                transform: rotateX(360deg) rotateY(360deg);
            }
        }

        .face {
            position: absolute;
            width: 64px;
            height: 64px;
            background: #fff;
            border: 1px solid #ccc;
            border-radius: 12px;
            display: grid;
            padding: 8px;
            gap: 4px;
            grid-template-areas: "a . c" "e g f" "d . b";
            box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.1);
        }

        .face.front {
            transform: translateZ(32px);
        }

        .face.back {
            transform: rotateY(180deg) translateZ(32px);
        }

        .face.right {
            transform: rotateY(90deg) translateZ(32px);
        }

        .face.left {
            transform: rotateY(-90deg) translateZ(32px);
        }

        .face.top {
            transform: rotateX(90deg) translateZ(32px);
        }

        .face.bottom {
            transform: rotateX(-90deg) translateZ(32px);
        }

        .pip {
            width: 100%;
            height: 100%;
            background: #333;
            border-radius: 50%;
            display: block;
            margin: auto;
        }

        .f1 .pip:nth-child(1) {
            grid-area: g;
            background: var(--red);
            width: 20px;
            height: 20px
        }

        .f2 .pip:nth-child(1) {
            grid-area: a
        }

        .f2 .pip:nth-child(2) {
            grid-area: b
        }

        .f3 .pip:nth-child(1) {
            grid-area: a
        }

        .f3 .pip:nth-child(2) {
            grid-area: g
        }

        .f3 .pip:nth-child(3) {
            grid-area: b
        }

        .f4 .pip:nth-child(1) {
            grid-area: a
        }

        .f4 .pip:nth-child(2) {
            grid-area: c
        }

        .f4 .pip:nth-child(3) {
            grid-area: d
        }

        .f4 .pip:nth-child(4) {
            grid-area: b
        }

        .f5 .pip:nth-child(1) {
            grid-area: a
        }

        .f5 .pip:nth-child(2) {
            grid-area: c
        }

        .f5 .pip:nth-child(3) {
            grid-area: g
        }

        .f5 .pip:nth-child(4) {
            grid-area: d
        }

        .f5 .pip:nth-child(5) {
            grid-area: b
        }

        .f6 .pip:nth-child(1) {
            grid-area: a
        }

        .f6 .pip:nth-child(2) {
            grid-area: c
        }

        .f6 .pip:nth-child(3) {
            grid-area: e
        }

        .f6 .pip:nth-child(4) {
            grid-area: f
        }

        .f6 .pip:nth-child(5) {
            grid-area: d
        }

        .f6 .pip:nth-child(6) {
            grid-area: b
        }

        .status-msg {
            font-weight: 700;
            color: #555;
        }

        /* --- Menus --- */
        .overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            z-index: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: 0.3s;
        }

        .overlay.active {
            opacity: 1;
            pointer-events: auto;
        }

        .card {
            background: white;
            padding: 25px;
            border-radius: 20px;
            width: 90%;
            max-width: 350px;
            text-align: center;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.4);
        }

        .btn {
            background: #1e293b;
            color: white;
            padding: 15px;
            width: 100%;
            border-radius: 12px;
            font-weight: bold;
            border: none;
            margin-top: 15px;
            cursor: pointer;
        }

        .row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 10px;
            margin-bottom: 8px;
        }

        .toggle {
            font-size: 0.8rem;
            padding: 5px 10px;
            border-radius: 6px;
            cursor: pointer;
            border: 1px solid #ccc;
        }

        .toggle.human {
            background: white;
        }

        .toggle.cpu {
            background: #1e293b;
            color: white;
        }

        .confetti {
            position: absolute;
            width: 8px;
            height: 8px;
            background: red;
            animation: fall 3s linear forwards;
        }

        @keyframes fall {
            to {
                transform: translateY(100vh) rotate(720deg);
            }
        }

        /* Responsive scaling */
        @media (max-width: 800px) {
            .outer {
                transform: scale(0.85);
            }
        }

        @media (max-width: 700px) {
            .outer {
                transform: scale(0.75);
            }
        }

        @media (max-width: 600px) {
            .outer {
                transform: scale(0.65);
            }

            .game-ui {
                padding: 10px 15px;
            }
        }

        @media (max-width: 500px) {
            .outer {
                transform: scale(0.55);
            }
        }
    </style>
</head>

<body>

    <!-- Menu -->
    <div id="menu-overlay" class="overlay active">
        <div class="card">
            <h1 style="font-size:2.5rem; margin-bottom:20px; font-weight:900">
                <span style="color:var(--red)">L</span><span style="color:var(--green)">U</span><span
                    style="color:var(--yellow)">D</span><span style="color:var(--blue)">O</span>
            </h1>
            <div id="setup-rows"></div>
            <button class="btn" onclick="Game.startGame()">PLAY NOW</button>
        </div>
    </div>

    <!-- Win Screen -->
    <div id="win-overlay" class="overlay">
        <div class="card">
            <i data-lucide="crown" size="50" color="#f1c40f" style="margin-bottom:10px"></i>
            <h2 id="winner-text">WINNER</h2>
            <button class="btn" onclick="Game.showMenu()">MAIN MENU</button>
        </div>
    </div>

    <!-- UI -->
    <div class="game-ui">
        <div class="player-indicator" id="turn-indicator">
            <div id="turn-dot" style="width:12px; height:12px; border-radius:50%; background:var(--red);"></div>
            <span id="turn-text">Red's Turn</span>
        </div>
        <button class="menu-btn" onclick="Game.showMenu()"><i data-lucide="menu" size="20"></i></button>
    </div>

    <!-- Board -->
    <div class="board-wrapper">
        <!-- Scale Container -->
        <div class="outer" id="board-container">
            <!-- Tokens -->
            <div class="tokens-layer" id="tokens-layer"></div>

            <!-- HTML Layout provided by user -->
            <div class="box_row">
                <div class="box red-base">

                </div>
                <div class="v_lad">
                    <div class="v_lad_row">
                        <div class="v_lad_cell"></div>
                        <div class="v_lad_cell"></div>
                        <div class="v_lad_cell"></div>
                    </div>
                    <div class="v_lad_row">
                        <div class="v_lad_cell"></div>
                        <div class="v_lad_cell green"></div>
                        <div class="v_lad_cell green"><span class="star">&#9733;</span></div>
                    </div>
                    <div class="v_lad_row">
                        <div class="v_lad_cell green"><span class="star">&#9733;</span></div>
                        <div class="v_lad_cell green"></div>
                        <div class="v_lad_cell"></div>
                    </div>
                    <div class="v_lad_row">
                        <div class="v_lad_cell"></div>
                        <div class="v_lad_cell green"></div>
                        <div class="v_lad_cell"></div>
                    </div>
                    <div class="v_lad_row">
                        <div class="v_lad_cell"></div>
                        <div class="v_lad_cell green"></div>
                        <div class="v_lad_cell"></div>
                    </div>
                    <div class="v_lad_row">
                        <div class="v_lad_cell"></div>
                        <div class="v_lad_cell green"></div>
                        <div class="v_lad_cell"></div>
                    </div>
                </div>
                <div class="box green-base">

                </div>
            </div>

            <div class="middle_row">
                <div class="h_lad">
                    <div class="h_lad_row">
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell red"><span class="star">&#9733;</span></div>
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell"></div>
                    </div>
                    <div class="h_lad_row">
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell red"></div>
                        <div class="h_lad_cell red"></div>
                        <div class="h_lad_cell red"></div>
                        <div class="h_lad_cell red"></div>
                        <div class="h_lad_cell red"></div>
                    </div>
                    <div class="h_lad_row">
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell red"><span class="star">&#9733;</span></div>
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell"></div>
                    </div>
                </div>
                <div class="ludo_home">
                    <div class="home-icon"><i data-lucide="trophy"></i></div>
                </div>
                <div class="h_lad">
                    <div class="h_lad_row">
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell yellow"><span class="star">&#9733;</span></div>
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell"></div>
                    </div>
                    <div class="h_lad_row">
                        <div class="h_lad_cell yellow"></div>
                        <div class="h_lad_cell yellow"></div>
                        <div class="h_lad_cell yellow"></div>
                        <div class="h_lad_cell yellow"></div>
                        <div class="h_lad_cell yellow"></div>
                        <div class="h_lad_cell"></div>
                    </div>
                    <div class="h_lad_row">
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell"></div>
                        <div class="h_lad_cell yellow"><span class="star">&#9733;</span></div>
                        <div class="h_lad_cell"></div>
                    </div>
                </div>
            </div>

            <div class="box_row">
                <div class="box blue-base">

                </div>
                <div class="v_lad">
                    <div class="v_lad_row">
                        <div class="v_lad_cell"></div>
                        <div class="v_lad_cell blue"></div>
                        <div class="v_lad_cell"></div>
                    </div>
                    <div class="v_lad_row">
                        <div class="v_lad_cell"></div>
                        <div class="v_lad_cell blue"></div>
                        <div class="v_lad_cell"></div>
                    </div>
                    <div class="v_lad_row">
                        <div class="v_lad_cell"></div>
                        <div class="v_lad_cell blue"></div>
                        <div class="v_lad_cell"></div>
                    </div>
                    <div class="v_lad_row">
                        <div class="v_lad_cell"></div>
                        <div class="v_lad_cell blue"></div>
                        <div class="v_lad_cell blue"><span class="star">&#9733;</span></div>
                    </div>
                    <div class="v_lad_row">
                        <div class="v_lad_cell blue"><span class="star">&#9733;</span></div>
                        <div class="v_lad_cell blue"></div>
                        <div class="v_lad_cell"></div>
                    </div>
                    <div class="v_lad_row">
                        <div class="v_lad_cell"></div>
                        <div class="v_lad_cell"></div>
                        <div class="v_lad_cell"></div>
                    </div>
                </div>
                <div class="box yellow-base">
                </div>
            </div>
        </div>
    </div>

    <!-- Controls -->
    <div class="controls-area">
        <div id="status-msg" class="status-msg">Touch dice to roll</div>
        <div class="dice-container" onclick="Game.humanRoll()">
            <div id="dice" class="dice">
                <div class="face front f1">
                    <div class="pip"></div>
                </div>
                <div class="face back f6">
                    <div class="pip"></div>
                    <div class="pip"></div>
                    <div class="pip"></div>
                    <div class="pip"></div>
                    <div class="pip"></div>
                    <div class="pip"></div>
                </div>
                <div class="face right f3">
                    <div class="pip"></div>
                    <div class="pip"></div>
                    <div class="pip"></div>
                </div>
                <div class="face left f4">
                    <div class="pip"></div>
                    <div class="pip"></div>
                    <div class="pip"></div>
                    <div class="pip"></div>
                </div>
                <div class="face top f2">
                    <div class="pip"></div>
                    <div class="pip"></div>
                </div>
                <div class="face bottom f5">
                    <div class="pip"></div>
                    <div class="pip"></div>
                    <div class="pip"></div>
                    <div class="pip"></div>
                    <div class="pip"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- Configuration ---
        const COLORS = ['red', 'green', 'yellow', 'blue'];
        const START_OFFSETS = { red: 0, green: 13, yellow: 26, blue: 39 };

        // 15x15 Grid Coordinates (each cell is 50x50 pixels)
        const PATH_MAP = {
            0: [1, 6], 1: [2, 6], 2: [3, 6], 3: [4, 6], 4: [5, 6], 5: [6, 5], 6: [6, 4], 7: [6, 3], 8: [6, 2], 9: [6, 1], 10: [6, 0],
            11: [7, 0], 12: [8, 0], 13: [8, 1], 14: [8, 2], 15: [8, 3], 16: [8, 4], 17: [8, 5], 18: [9, 6], 19: [10, 6], 20: [11, 6], 21: [12, 6], 22: [13, 6], 23: [14, 6],
            24: [14, 7], 25: [14, 8], 26: [13, 8], 27: [12, 8], 28: [11, 8], 29: [10, 8], 30: [9, 8], 31: [8, 9], 32: [8, 10], 33: [8, 11], 34: [8, 12], 35: [8, 13], 36: [8, 14],
            37: [7, 14], 38: [6, 14], 39: [6, 13], 40: [6, 12], 41: [6, 11], 42: [6, 10], 43: [6, 9], 44: [5, 8], 45: [4, 8], 46: [3, 8], 47: [2, 8], 48: [1, 8], 49: [0, 8],
            50: [0, 7], 51: [0, 6]
        };

        const HOME_PATHS = {
            red: [[1, 7], [2, 7], [3, 7], [4, 7], [5, 7], [6, 7]],
            green: [[7, 1], [7, 2], [7, 3], [7, 4], [7, 5], [7, 6]],
            yellow: [[13, 7], [12, 7], [11, 7], [10, 7], [9, 7], [8, 7]],
            blue: [[7, 13], [7, 12], [7, 11], [7, 10], [7, 9], [7, 8]]
        };

        const STAR_CELLS = [8, 21, 34, 47]; // Safe star positions

        const Game = {
            state: {
                turn: 0,
                diceVal: 1,
                canRoll: false,
                isAnimating: false,
                tokens: {},
                players: { red: true, green: false, yellow: false, blue: false },
                consecutiveSixes: 0
            },

            els: {
                board: document.getElementById('board-container'),
                layer: document.getElementById('tokens-layer'),
                dice: document.getElementById('dice'),
                msg: document.getElementById('status-msg'),
                menu: document.getElementById('menu-overlay'),
                win: document.getElementById('win-overlay'),
                turnText: document.getElementById('turn-text'),
                turnDot: document.getElementById('turn-dot')
            },

            init() {
                lucide.createIcons();
                this.buildMenu();
                window.addEventListener('resize', () => this.scaleBoard());
                this.scaleBoard();
            },

            scaleBoard() {
                // Scale board to fit screen
                const padding = 20;
                const availW = window.innerWidth - padding;
                const availH = window.innerHeight - 160;
                const scale = Math.min(availW / 750, availH / 750, 1);
                this.els.board.style.transform = `scale(${scale})`;
            },

            buildMenu() {
                const container = document.getElementById('setup-rows');
                container.innerHTML = '';
                COLORS.forEach(color => {
                    container.innerHTML += `
                    <div class="row">
                        <div style="display:flex;align-items:center;gap:10px;text-transform:capitalize;font-weight:700">
                            <div style="width:12px;height:12px;background:var(--${color});border-radius:50%"></div>
                            ${color}
                        </div>
                        <div class="toggle ${this.state.players[color] ? 'human' : 'cpu'}" 
                             id="tg-${color}" 
                             onclick="Game.togglePlayer('${color}')">
                            ${this.state.players[color] ? 'PLAYER' : 'CPU'}
                        </div>
                    </div>`;
                });
            },

            togglePlayer(color) {
                this.state.players[color] = !this.state.players[color];
                this.buildMenu();
            },

            startGame() {
                this.els.menu.classList.remove('active');
                this.reset();
            },

            showMenu() {
                this.els.win.classList.remove('active');
                this.els.menu.classList.add('active');
            },

            reset() {
                // Reset game state
                this.state.tokens = {
                    red: [-1, -1, -1, -1],
                    green: [-1, -1, -1, -1],
                    yellow: [-1, -1, -1, -1],
                    blue: [-1, -1, -1, -1]
                };
                this.state.turn = 0;
                this.state.isAnimating = false;
                this.state.consecutiveSixes = 0;

                // Create tokens
                this.createTokens();
                this.renderTokens();
                this.startTurn();
            },

            createTokens() {
                this.els.layer.innerHTML = '';
                COLORS.forEach(color => {
                    for (let i = 0; i < 4; i++) {
                        const token = document.createElement('div');
                        token.className = `token ${color} in-base`;
                        token.id = `tok-${color}-${i}`;
                        token.textContent = i + 1; // Number on token
                        token.onclick = (e) => {
                            e.stopPropagation();
                            this.handleTokenClick(color, i);
                        };
                        this.els.layer.appendChild(token);
                    }
                });
            },

            startTurn() {
                const color = COLORS[this.state.turn];
                this.state.canRoll = true;
                this.updateUI();
                if (!this.state.players[color]) {
                    setTimeout(() => this.roll(), 800);
                }
            },

            humanRoll() {
                if (this.state.canRoll && this.state.players[COLORS[this.state.turn]]) {
                    this.roll();
                }
            },

            roll() {
                this.state.canRoll = false;
                this.els.dice.classList.add('rolling');

                // Multiple quick rolls for animation effect
                let rolls = 0;
                const rollInterval = setInterval(() => {
                    const tempVal = Math.floor(Math.random() * 6) + 1;
                    this.updateDice(tempVal);
                    rolls++;

                    if (rolls > 5) {
                        clearInterval(rollInterval);
                        this.finalizeRoll();
                    }
                }, 80);
            },

            updateDice(val) {
                const map = {
                    1: [0, 0],
                    2: [-90, 0],
                    3: [0, -90],
                    4: [0, 90],
                    5: [90, 0],
                    6: [180, 0]
                };
                const [x, y] = map[val];
                this.els.dice.style.transform = `translateZ(-32px) rotateX(${x}deg) rotateY(${y}deg)`;
            },

            finalizeRoll() {
                this.state.diceVal = Math.floor(Math.random() * 6) + 1;
                this.els.dice.classList.remove('rolling');
                this.updateDice(this.state.diceVal);
                this.checkMoves();
            },

            checkMoves() {
                const color = COLORS[this.state.turn];
                const roll = this.state.diceVal;
                const moves = [];

                // Get valid moves
                this.state.tokens[color].forEach((pos, i) => {
                    if ((pos === -1 && roll === 6) || (pos !== -1 && pos + roll <= 57)) {
                        moves.push(i);
                    }
                });

                if (moves.length === 0) {
                    this.els.msg.innerText = "No moves possible";
                    setTimeout(() => this.nextTurn(), 1000);
                } else {
                    if (this.state.players[color]) {
                        this.els.msg.innerText = "Tap a token";
                        this.highlightTokens(moves);
                    } else {
                        setTimeout(() => this.cpuMove(moves), 800);
                    }
                }
            },

            cpuMove(moves) {
                const color = COLORS[this.state.turn];
                let bestMove = moves[0];

                // Try to exit base first
                const exitMove = moves.find(i => this.state.tokens[color][i] === -1);
                if (exitMove !== undefined) {
                    bestMove = exitMove;
                }

                this.move(color, bestMove);
            },

            handleTokenClick(color, i) {
                if (this.state.isAnimating || COLORS[this.state.turn] !== color) return;

                const pos = this.state.tokens[color][i];
                const roll = this.state.diceVal;

                if ((pos === -1 && roll === 6) || (pos !== -1 && pos + roll <= 57)) {
                    this.clearHighlights();
                    this.move(color, i);
                }
            },

            async move(color, tokenIndex) {
                this.state.isAnimating = true;
                const roll = this.state.diceVal;

                // Check for three consecutive sixes
                if (roll === 6) {
                    this.state.consecutiveSixes++;
                    if (this.state.consecutiveSixes >= 3) {
                        this.els.msg.innerText = "Three 6s! Turn skipped";
                        this.state.consecutiveSixes = 0;
                        setTimeout(() => this.nextTurn(), 1500);
                        return;
                    }
                } else {
                    this.state.consecutiveSixes = 0;
                }

                let currentPos = this.state.tokens[color][tokenIndex];

                // Move step by step
                if (currentPos === -1) {
                    // Exit from base
                    this.state.tokens[color][tokenIndex] = 0;
                    this.renderTokens();
                    await this.wait(300);
                } else {
                    for (let step = 0; step < roll; step++) {
                        this.state.tokens[color][tokenIndex]++;
                        this.renderTokens();
                        await this.wait(200);
                    }
                }

                const finalPos = this.state.tokens[color][tokenIndex];

                // Check for capture
                if (finalPos < 51) {
                    this.checkCapture(color, finalPos);
                }

                // Check for win
                if (finalPos === 57 && this.state.tokens[color].every(p => p === 57)) {
                    this.win(color);
                    return;
                }

                // Extra turn for rolling 6
                if (roll === 6 && finalPos !== 57) {
                    this.els.msg.innerText = "Rolled 6! Go again";
                    this.state.isAnimating = false;
                    this.startTurn();
                } else {
                    this.nextTurn();
                }
            },

            checkCapture(activeColor, step) {
                const absPos = (START_OFFSETS[activeColor] + step) % 52;

                // Can't capture on safe star cells
                if (STAR_CELLS.includes(absPos)) return;

                let captured = false;

                COLORS.forEach(otherColor => {
                    if (otherColor === activeColor) return;

                    this.state.tokens[otherColor].forEach((pos, i) => {
                        if (pos !== -1 && pos < 51) {
                            const otherAbsPos = (START_OFFSETS[otherColor] + pos) % 52;
                            if (otherAbsPos === absPos) {
                                this.state.tokens[otherColor][i] = -1;
                                captured = true;
                            }
                        }
                    });
                });

                if (captured) {
                    this.els.msg.innerText = "Token captured!";
                    this.renderTokens();
                }
            },

            win(color) {
                document.getElementById('winner-text').innerText = `${color.toUpperCase()} WINS!`;
                document.getElementById('winner-text').style.color = `var(--${color})`;
                this.els.win.classList.add('active');
                this.createConfetti();
            },

            nextTurn() {
                this.state.turn = (this.state.turn + 1) % 4;
                this.state.isAnimating = false;
                this.startTurn();
            },

            // --- Rendering Tokens ---
            renderTokens() {
                const positions = {}; // Track stacking

                COLORS.forEach(color => {
                    this.state.tokens[color].forEach((pos, i) => {
                        const token = document.getElementById(`tok-${color}-${i}`);
                        if (!token) return;

                        // Reset token classes
                        token.className = `token ${color}`;

                        let x, y;

                        if (pos === -1) {
                            // Token in base
                            token.classList.add('in-base');

                            // Calculate base position
                            let baseX = 0, baseY = 0;
                            if (color === 'green') baseX = 450; // Right side
                            if (color === 'blue') baseY = 450; // Bottom side
                            if (color === 'yellow') { baseX = 450; baseY = 450; } // Bottom-right

                            // Position within 2x2 grid in base (50px margins)
                            const row = Math.floor(i / 2);
                            const col = i % 2;
                            const localX = 50 + (col * 150); // 50px margin + column spacing
                            const localY = 50 + (row * 150); // 50px margin + row spacing

                            x = baseX + localX;
                            y = baseY + localY;

                            // Center token in the 50px circle
                            x += 5; // (50 - 40) / 2 = 5px offset
                            y += 5;

                        } else if (pos >= 57) {
                            // Token in center
                            token.classList.add('in-center');
                            x = 350; // Center of board
                            y = 350;

                        } else if (pos > 50) {
                            // Token in home stretch
                            token.classList.add('in-home-stretch');
                            const homeIndex = pos - 51;
                            const coords = HOME_PATHS[color][homeIndex];
                            const gridX = coords[0];
                            const gridY = coords[1];

                            x = gridX * 50;
                            y = gridY * 50;

                            // Center in cell
                            x += 12.5; // (50 - 25) / 2 = 12.5px offset
                            y += 12.5;

                        } else {
                            // Token on main path
                            token.classList.add('on-board');
                            const absPos = (START_OFFSETS[color] + pos) % 52;
                            const coords = PATH_MAP[absPos];
                            const gridX = coords[0];
                            const gridY = coords[1];

                            x = gridX * 50;
                            y = gridY * 50;

                            // Center in cell
                            x += 10; // (50 - 30) / 2 = 10px offset
                            y += 10;

                            // Handle stacking
                            const key = `${gridX},${gridY}`;
                            if (!positions[key]) positions[key] = 0;
                            const stackIdx = positions[key]++;

                            if (stackIdx > 0) {
                                const angle = (stackIdx * 90) * Math.PI / 180;
                                const radius = 8;
                                x += Math.cos(angle) * radius;
                                y += Math.sin(angle) * radius;
                                token.classList.add(`stacked-${stackIdx + 1}`);
                            }
                        }

                        // Set position
                        token.style.left = `${x}px`;
                        token.style.top = `${y}px`;

                        // Set z-index for current player's tokens
                        if (color === COLORS[this.state.turn]) {
                            token.style.zIndex = '20';
                        } else {
                            token.style.zIndex = '10';
                        }
                    });
                });
            },

            highlightTokens(indices) {
                indices.forEach(i => {
                    const token = document.getElementById(`tok-${COLORS[this.state.turn]}-${i}`);
                    if (token) token.classList.add('pulse');
                });
            },

            clearHighlights() {
                document.querySelectorAll('.token').forEach(t => t.classList.remove('pulse'));
            },

            updateUI() {
                const color = COLORS[this.state.turn];
                this.els.turnText.innerText = `${color}'s Turn`;
                this.els.turnDot.style.background = `var(--${color})`;
                this.els.msg.innerText = this.state.players[color] ? "Tap dice to roll" : "CPU thinking...";
            },

            wait(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            },

            createConfetti() {
                for (let i = 0; i < 50; i++) {
                    const confetti = document.createElement('div');
                    confetti.className = 'confetti';
                    confetti.style.left = Math.random() * 100 + '%';
                    confetti.style.background = ['red', 'yellow', 'green', 'blue'][Math.floor(Math.random() * 4)];
                    document.body.appendChild(confetti);
                }
            }
        };

        Game.init();
    </script>
</body>

</html>