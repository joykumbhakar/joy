<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Weather Forecast</title>
    
    <!-- PWA Manifest (Data URI for Single File Compatibility) -->
    <link rel="manifest" id="manifest-placeholder">
    <meta name="theme-color" content="#0f172a">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Hind+Siliguri:wght@400;600&family=Poppins:wght@400;600&family=JetBrains+Mono:wght@400;700&display=swap" rel="stylesheet">

    <style>
        /* --- Liquid Glass & Animation Styles --- */
        body {
            font-family: 'Inter', 'Hind Siliguri', 'Poppins', sans-serif;
            overflow-x: hidden;
            background-color: #0f172a;
        }

        /* --- ADVANCED LIQUID BLOB ENGINE --- */
        .liquid-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background-color: var(--bg-color);
            transition: background-color 1.5s ease;
            
            /* Default (Fallback) */
            --bg-color: #0f172a;
            --blob-1: #3b82f6;
            --blob-2: #60a5fa;
            --blob-3: #fcd34d;
        }

        /* --- DAY THEMES --- */
        .liquid-bg.day-clear {
            --bg-color: #38bdf8; /* Sky Blue */
            --blob-1: #0ea5e9;
            --blob-2: #bae6fd;
            --blob-3: #fde047; /* Sun */
        }

        .liquid-bg.day-cloudy {
            --bg-color: #64748b; /* Slate */
            --blob-1: #94a3b8;
            --blob-2: #cbd5e1;
            --blob-3: #475569;
        }

        .liquid-bg.day-rain {
            --bg-color: #334155; /* Dark Slate */
            --blob-1: #475569;
            --blob-2: #1e293b;
            --blob-3: #0f172a;
        }

        .liquid-bg.day-snow {
            --bg-color: #e2e8f0; /* Very Light Gray */
            --blob-1: #ffffff;
            --blob-2: #bfdbfe; /* Ice Blue */
            --blob-3: #f1f5f9;
        }

        .liquid-bg.day-thunder {
            --bg-color: #4c1d95; /* Deep Purple */
            --blob-1: #6d28d9;
            --blob-2: #1e1b4b;
            --blob-3: #fbbf24; /* Lightning Yellow */
        }

        .liquid-bg.day-fog {
            --bg-color: #94a3b8; /* Misty */
            --blob-1: #cbd5e1;
            --blob-2: #e2e8f0;
            --blob-3: #64748b;
        }

        /* --- NIGHT THEMES --- */
        .liquid-bg.night-clear {
            --bg-color: #020617; /* Deepest Blue */
            --blob-1: #1e1b4b;
            --blob-2: #312e81;
            --blob-3: #4f46e5; /* Indigo */
        }

        .liquid-bg.night-cloudy {
            --bg-color: #0f172a;
            --blob-1: #1e293b;
            --blob-2: #334155;
            --blob-3: #020617;
        }

        .liquid-bg.night-rain {
            --bg-color: #020617;
            --blob-1: #0f172a;
            --blob-2: #1e293b;
            --blob-3: #172554; /* Deep Ocean */
        }

        .liquid-bg.night-snow {
            --bg-color: #172554; /* Blue Night */
            --blob-1: #1e3a8a;
            --blob-2: #93c5fd; /* Frost */
            --blob-3: #bfdbfe;
        }

        .liquid-bg.night-thunder {
            --bg-color: #000000;
            --blob-1: #581c87; /* Violet */
            --blob-2: #2e1065;
            --blob-3: #f59e0b; /* Amber Flash */
        }

        .liquid-bg.night-fog {
            --bg-color: #1e293b;
            --blob-1: #334155;
            --blob-2: #0f172a;
            --blob-3: #475569;
        }

        /* Blobs Animation */
        .blob {
            position: absolute;
            border-radius: 50%;
            filter: blur(80px);
            opacity: 0.6;
            animation: morph 20s infinite alternate cubic-bezier(0.4, 0, 0.2, 1);
            will-change: transform, border-radius, background-color;
            transition: background-color 1.5s ease;
        }

        .blob-1 { top: -10%; left: -10%; width: 50vw; height: 50vw; background: var(--blob-1); animation-delay: 0s; }
        .blob-2 { bottom: -10%; right: -10%; width: 50vw; height: 50vw; background: var(--blob-2); animation-delay: -5s; }
        .blob-3 { top: 40%; left: 40%; width: 40vw; height: 40vw; background: var(--blob-3); animation-delay: -10s; opacity: 0.4; }

        @keyframes morph {
            0% { transform: translate(0, 0) scale(1); border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; }
            33% { transform: translate(30px, -50px) scale(1.1); border-radius: 50% 50% 20% 80% / 25% 80% 20% 75%; }
            66% { transform: translate(-20px, 20px) scale(0.9); border-radius: 67% 33% 47% 53% / 37% 59% 41% 63%; }
            100% { transform: translate(0, 0) scale(1); border-radius: 30% 70% 70% 30% / 30% 30% 70% 70%; }
        }

        /* Glassmorphism Cards */
        .glass-card {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
        }
        
        .glass-input {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }
        
        .glass-input option {
            background-color: #1e293b;
            color: white;
        }
        
        .glass-input:focus {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            outline: none;
        }

        /* Text Gradients */
        .text-gradient {
            background: linear-gradient(to right, #ffffff, #bfdbfe);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        /* 3D Icon Container Styles */
        .icon-box-3d {
            background: linear-gradient(145deg, rgba(255,255,255,0.15), rgba(255,255,255,0.05));
            box-shadow: 5px 5px 10px rgba(0,0,0,0.1), -5px -5px 10px rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
        }

        /* --- IMPROVED CLOCK WIDGET STYLES --- */
        .clock-card {
            background: rgba(15, 23, 42, 0.4); /* Darker backdrop for contrast */
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 4px 6px -1px rgba(0, 0, 0, 0.1), 
                0 2px 4px -1px rgba(0, 0, 0, 0.06),
                inset 0 0 20px rgba(255, 255, 255, 0.05);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .font-mono-clock {
            font-family: 'JetBrains Mono', monospace;
            font-variant-numeric: tabular-nums; /* Keeps numbers steady */
            letter-spacing: -0.02em;
            text-shadow: 0 0 15px rgba(56, 189, 248, 0.6); /* Neon Glow */
        }

        /* Custom Scrollbar */
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        /* Loader */
        .loader {
            border: 3px solid rgba(255,255,255,0.1);
            border-left-color: #fff;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Chart Container */
        #chart-container { position: relative; height: 200px; width: 100%; }

        /* --- ENHANCED 3D WEATHER SCENE --- */
        .scene-container {
            width: 240px;
            height: 240px;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            perspective: 1000px;
            transform: scale(0.9);
        }

        @media (max-width: 640px) {
            .scene-container {
                transform: scale(0.7);
                height: 180px;
            }
        }

        /* 3D Sun */
        .sun-obj {
            width: 110px;
            height: 110px;
            background: radial-gradient(circle at 30% 30%, #fff7ed, #fcd34d, #f59e0b);
            border-radius: 50%;
            position: absolute;
            top: 20px;
            right: 20px;
            box-shadow: 
                inset -10px -10px 30px rgba(180, 83, 9, 0.4),
                0 0 60px rgba(251, 191, 36, 0.8),
                0 0 20px rgba(255, 255, 255, 0.5);
            z-index: 1;
            transition: all 1s ease;
        }
        
        .sun-aura {
            position: absolute;
            top: 45px;
            right: 45px;
            width: 200px;
            height: 200px;
            background: radial-gradient(circle, rgba(251, 191, 36, 0.3) 0%, transparent 70%);
            border-radius: 50%;
            z-index: 0;
            transform: translate(50%, -50%);
            animation: sunPulse 5s infinite alternate ease-in-out;
        }

        @keyframes sunPulse {
            0% { transform: translate(50%, -50%) scale(0.95); opacity: 0.6; }
            100% { transform: translate(50%, -50%) scale(1.15); opacity: 0.9; }
        }

        /* 3D Moon */
        .moon-obj {
            width: 100px;
            height: 100px;
            background: radial-gradient(circle at 30% 30%, #f1f5f9, #cbd5e1, #64748b);
            border-radius: 50%;
            position: absolute;
            top: 25px;
            right: 25px;
            box-shadow: 
                inset -15px -15px 30px rgba(15, 23, 42, 0.8), 
                0 0 40px rgba(226, 232, 240, 0.4);
            z-index: 1;
            transition: all 1s ease;
        }
        .crater {
            background: rgba(30, 41, 59, 0.15);
            border-radius: 50%;
            position: absolute;
            box-shadow: inset 1px 1px 3px rgba(0,0,0,0.3);
        }
        .c1 { width: 25px; height: 25px; top: 20%; left: 30%; }
        .c2 { width: 12px; height: 12px; top: 60%; left: 60%; }
        .c3 { width: 18px; height: 18px; top: 40%; left: 70%; }

        /* 3D Clouds */
        .cloud-group {
            position: absolute;
            z-index: 10;
            width: 100%;
            height: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            filter: drop-shadow(0 25px 30px rgba(0,0,0,0.3));
            animation: float 6s ease-in-out infinite;
            transition: all 1s ease;
        }

        .cloud-part {
            background: linear-gradient(180deg, #ffffff 0%, #e2e8f0 50%, #94a3b8 100%);
            position: absolute;
            box-shadow: 
                inset 4px 4px 10px rgba(255,255,255,0.9), 
                inset -5px -10px 15px rgba(30, 41, 59, 0.1);
        }

        .cloud-base {
            width: 170px;
            height: 70px;
            border-radius: 60px;
            margin-top: 50px;
            margin-left: -20px;
            z-index: 3;
        }

        .c-1 { width: 90px; height: 90px; border-radius: 50%; top: -50px; left: 10px; z-index: 2; }
        .c-2 { width: 70px; height: 70px; border-radius: 50%; top: -35px; left: 80px; z-index: 1; }
        .c-3 { width: 50px; height: 50px; border-radius: 50%; top: -10px; left: -20px; z-index: 2; }

        @keyframes float {
            0% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-12px) rotate(1deg); }
            100% { transform: translateY(0px) rotate(0deg); }
        }

        /* 3D Rain */
        .rain-container {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 5;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.5s;
        }

        .raindrop {
            background: linear-gradient(180deg, rgba(96,165,250,0), #93c5fd);
            width: 3px;
            height: 15px;
            position: absolute;
            border-radius: 2px;
            opacity: 0.8;
            box-shadow: 0 0 5px rgba(147, 197, 253, 0.8);
            animation: rainFall 0.7s linear infinite;
        }

        @keyframes rainFall {
            0% { transform: translateY(60px) scaleY(1); opacity: 0; }
            10% { opacity: 0.9; }
            100% { transform: translateY(220px) scaleY(1); opacity: 0; }
        }

        /* 3D Snow */
        .snow-container {
            position: absolute; width: 100%; height: 100%; z-index: 5; pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }
        .snowflake {
            background: white;
            width: 6px; height: 6px;
            border-radius: 50%;
            position: absolute;
            filter: blur(1px);
            box-shadow: 0 0 5px rgba(255,255,255,0.8);
            animation: snowFall 3s linear infinite;
        }
        @keyframes snowFall {
            0% { transform: translateY(-10px) translateX(0); opacity: 0; }
            20% { opacity: 1; }
            100% { transform: translateY(220px) translateX(20px); opacity: 0; }
        }

        /* 3D Thunder */
        .thunder-container {
            position: absolute; width: 100%; height: 100%; z-index: 4; pointer-events: none; opacity: 0; transition: opacity 0.5s;
        }
        .lightning {
            position: absolute;
            width: 40px; height: 80px;
            top: 70px; left: 50%;
            background: #fcd34d;
            clip-path: polygon(40% 0%, 0% 50%, 40% 50%, 20% 100%, 80% 40%, 40% 40%);
            opacity: 0;
            transform: translateX(-50%) scale(0);
            filter: drop-shadow(0 0 15px #fcd34d);
            animation: thunderFlash 3s infinite;
        }
        .l1 { animation-delay: 0s; left: 45%; }
        .l2 { animation-delay: 1.5s; left: 65%; transform: scale(0.8) translateX(-50%); }

        @keyframes thunderFlash {
            0%, 90%, 100% { opacity: 0; transform: translateX(-50%) scale(0); }
            92% { opacity: 1; transform: translateX(-50%) scale(1.2); }
            94% { opacity: 0; transform: translateX(-50%) scale(1.2); }
            96% { opacity: 1; transform: translateX(-50%) scale(1.2); }
        }

        /* Dynamic States */
        .state-hidden { opacity: 0 !important; transform: scale(0.5) !important; pointer-events: none; }
        .state-visible { opacity: 1 !important; transform: scale(1) !important; }
        .cloud-only .sun-obj, .cloud-only .sun-aura, .cloud-only .moon-obj { opacity: 0; }
        
        /* Icon Colors */
        .icon-blue { color: #60a5fa; filter: drop-shadow(0 0 5px rgba(96,165,250,0.5)); }
        .icon-yellow { color: #fcd34d; filter: drop-shadow(0 0 5px rgba(252,211,77,0.5)); }
        .icon-white { color: #fff; filter: drop-shadow(0 0 5px rgba(255,255,255,0.3)); }
        .icon-purple { color: #c084fc; filter: drop-shadow(0 0 5px rgba(192,132,252,0.5)); }

    </style>
</head>
<body class="text-white selection:bg-white/30">

    <!-- Background Layer (Replaced with Blob Engine) -->
    <div id="bg-layer" class="liquid-bg">
        <div class="blob blob-1"></div>
        <div class="blob blob-2"></div>
        <div class="blob blob-3"></div>
        <!-- Noise Texture Overlay -->
        <div style="position: absolute; inset:0; background: url('data:image/svg+xml,%3Csvg viewBox=\'0 0 200 200\' xmlns=\'http://www.w3.org/2000/svg\'%3E%3Cfilter id=\'noiseFilter\'%3E%3CfeTurbulence type=\'fractalNoise\' baseFrequency=\'0.8\' numOctaves=\'3\' stitchTiles=\'stitch\'/%3E%3C/filter%3E%3Crect width=\'100%25\' height=\'100%25\' filter=\'url(%23noiseFilter)\' opacity=\'0.06\'/%3E%3C/svg%3E'); opacity:0.4; mix-blend-mode: overlay;"></div>
    </div>

    <!-- App Container -->
    <div class="max-w-7xl mx-auto p-4 sm:p-6 lg:p-8 min-h-screen flex flex-col relative z-10">
        
        <!-- Header -->
        <header class="flex flex-col sm:flex-row items-center justify-between gap-6 mb-8 fade-in">
            <div class="flex items-center gap-4 w-full sm:w-auto justify-between sm:justify-start">
                
                <div class="flex items-center gap-4">
                    <!-- Location Button -->
                    <button id="locate-btn" class="p-3 bg-blue-500/20 border border-blue-400/30 rounded-2xl transition-all active:scale-95" title="Locate Me">
                        <i data-lucide="map-pin" class="w-6 h-6 text-blue-300 transition-colors"></i>
                    </button>
                    
                    <!-- Install App Button (Hidden by default) -->
                    <button id="install-btn" class="hidden p-3 bg-emerald-500/20 border border-emerald-400/30 rounded-2xl transition-all active:scale-95" title="Add to Home Screen">
                        <i data-lucide="download" class="w-6 h-6 text-emerald-300 transition-colors"></i>
                    </button>

                    <div class="flex flex-col">
                        <h1 id="location-name" class="text-xl sm:text-2xl font-bold tracking-tight text-gradient drop-shadow-sm truncate max-w-[200px] sm:max-w-md">Detecting...</h1>
                        
                        <!-- NEW IMPROVED CLOCK WIDGET -->
                        <div class="clock-card flex items-center gap-4 px-5 py-3 rounded-2xl mt-1 cursor-default relative overflow-hidden">
                            
                            <!-- Animated Icon -->
                            <div class="relative w-10 h-10 flex items-center justify-center rounded-xl bg-white/5 border border-white/10 shadow-inner">
                                <i data-lucide="clock" class="w-5 h-5 text-blue-300 relative z-10"></i>
                                <!-- Orbiting/Pulsing Dot -->
                                <div class="absolute -top-1 -right-1 w-3 h-3">
                                    <span class="absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75 animate-ping"></span>
                                    <span class="relative inline-flex rounded-full h-3 w-3 bg-emerald-500 border-2 border-white/10"></span>
                                </div>
                            </div>

                            <div class="flex flex-col z-10">
                                <!-- Time -->
                                <span id="current-time" class="text-2xl font-mono-clock font-bold tracking-wider text-white leading-none drop-shadow-md">--:--</span>
                                <!-- Date & Location Label -->
                                <div class="flex items-center gap-2 mt-1">
                                    <span class="w-1.5 h-1.5 rounded-full bg-blue-400"></span>
                                    <span id="current-date" class="text-[10px] uppercase font-bold text-blue-100/60 tracking-[0.2em] leading-none">Loading...</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-auto mt-4 sm:mt-0">
                <!-- Language Selector -->
                <div class="relative">
                    <select id="lang-select" class="glass-input appearance-none rounded-2xl py-3 pl-4 pr-10 text-white font-medium cursor-pointer w-full">
                        <option value="en">English</option>
                        <option value="bn">বাংলা</option>
                        <option value="hi">हिन्दी</option>
                    </select>
                    <i data-lucide="languages" class="absolute right-3 top-1/2 -translate-y-1/2 w-4 h-4 text-white/50 pointer-events-none"></i>
                </div>

                <form id="search-form" class="relative w-full sm:w-64 group">
                    <input 
                        type="text" 
                        id="search-input"
                        placeholder="Search city..." 
                        class="w-full glass-input rounded-2xl py-3 pl-12 pr-4 text-white placeholder:text-white/50 transition-all duration-300 shadow-lg"
                    >
                    <!-- Icon Wrapper to prevent Lucide replacement issues -->
                    <div id="search-icon-wrapper" class="absolute left-4 top-1/2 -translate-y-1/2 w-5 h-5 text-white/50 group-focus-within:text-white transition-colors pointer-events-none">
                        <i data-lucide="search" class="w-full h-full"></i>
                    </div>
                    <div id="search-loader" class="loader absolute right-4 top-1/2 -translate-y-1/2 hidden"></div>
                </form>
            </div>
        </header>

        <!-- Main Grid -->
        <div id="main-content" class="grid grid-cols-1 lg:grid-cols-3 gap-6 opacity-0 transition-opacity duration-700">
            
            <!-- Left Column (Current Weather & Details) -->
            <div class="lg:col-span-2 space-y-6">
                
                <!-- Hero Section (3D Scene) - HOVER REMOVED -->
                <div class="glass-card rounded-[2.5rem] p-6 sm:p-12 relative overflow-hidden">
                    <!-- Decorative glow -->
                    <div class="absolute top-0 right-0 w-64 h-64 bg-white/10 rounded-full blur-3xl -translate-y-1/2 translate-x-1/2 pointer-events-none"></div>
                    
                    <div class="relative z-10 flex flex-col-reverse sm:flex-row items-center sm:items-start justify-between gap-8">
                        <div class="text-center sm:text-left space-y-2 relative z-20 w-full sm:w-auto">
                            <div class="inline-flex items-center gap-2 px-4 py-1.5 rounded-full bg-white/10 border border-white/10 text-sm font-medium backdrop-blur-md shadow-inner">
                                <span id="weather-dot" class="w-2 h-2 rounded-full bg-yellow-400 animate-pulse box-shadow-glow"></span>
                                <span id="weather-desc" class="text-white/90">Clear Sky</span>
                            </div>
                            <!-- Gradient Text for Temp -->
                            <h2 id="current-temp" class="text-7xl sm:text-9xl font-bold tracking-tighter text-gradient drop-shadow-2xl">
                                --°
                            </h2>
                            <div class="flex items-center justify-center sm:justify-start gap-6 text-xl font-medium text-white/80">
                                <span class="flex items-center gap-1"><i data-lucide="arrow-up" class="w-4 h-4 text-red-300"></i> <span id="max-temp">--°</span></span>
                                <span class="flex items-center gap-1"><i data-lucide="arrow-down" class="w-4 h-4 text-blue-300"></i> <span id="min-temp">--°</span></span>
                            </div>
                            <p id="summary-text" class="text-white/70 max-w-xs mt-4 text-lg leading-relaxed font-light mx-auto sm:mx-0">
                                Loading weather data...
                            </p>
                        </div>
                        
                        <!-- 3D Weather Animation Container -->
                        <div class="relative pointer-events-none w-full flex justify-center sm:justify-end">
                            <div class="scene-container" id="weather-scene">
                                <!-- Sun -->
                                <div class="sun-aura"></div>
                                <div class="sun-obj" id="anim-sun"></div>

                                <!-- Moon -->
                                <div class="moon-obj" id="anim-moon">
                                    <div class="crater c1"></div>
                                    <div class="crater c2"></div>
                                    <div class="crater c3"></div>
                                </div>
                                
                                <!-- Clouds -->
                                <div class="cloud-group" id="anim-cloud">
                                    <div class="cloud-base cloud-part"></div>
                                    <div class="c-1 cloud-part"></div>
                                    <div class="c-2 cloud-part"></div>
                                    <div class="c-3 cloud-part"></div>
                                </div>

                                <!-- Rain -->
                                <div class="rain-container" id="anim-rain">
                                    <div class="raindrop" style="left: 20%; animation-delay: 0s;"></div>
                                    <div class="raindrop" style="left: 40%; animation-delay: 0.2s;"></div>
                                    <div class="raindrop" style="left: 60%; animation-delay: 0.4s;"></div>
                                    <div class="raindrop" style="left: 30%; animation-delay: 0.6s;"></div>
                                    <div class="raindrop" style="left: 50%; animation-delay: 0.1s;"></div>
                                    <div class="raindrop" style="left: 70%; animation-delay: 0.3s;"></div>
                                </div>

                                <!-- Snow -->
                                <div class="snow-container" id="anim-snow">
                                    <div class="snowflake" style="left: 20%; animation-delay: 0s;"></div>
                                    <div class="snowflake" style="left: 40%; animation-delay: 1.2s;"></div>
                                    <div class="snowflake" style="left: 60%; animation-delay: 2.4s;"></div>
                                    <div class="snowflake" style="left: 30%; animation-delay: 0.6s;"></div>
                                    <div class="snowflake" style="left: 50%; animation-delay: 1.8s;"></div>
                                    <div class="snowflake" style="left: 70%; animation-delay: 0.3s;"></div>
                                </div>

                                <!-- Thunder -->
                                <div class="thunder-container" id="anim-thunder">
                                    <div class="lightning l1"></div>
                                    <div class="lightning l2"></div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid (3D Icons) -->
                <div class="grid grid-cols-2 sm:grid-cols-4 gap-4">
                    <!-- Wind -->
                    <div class="glass-card interactive-card rounded-2xl p-4 sm:p-5 flex flex-col justify-between transition-all duration-300">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="icon-box-3d p-2 rounded-xl">
                                <i data-lucide="wind" class="w-5 h-5 icon-white"></i>
                            </div>
                            <span class="text-sm font-medium text-white/70" data-translate="wind">Wind</span>
                        </div>
                        <div>
                            <div id="stat-wind" class="text-xl sm:text-2xl font-bold text-white">--</div>
                            <div class="text-xs text-white/40 mt-1">km/h</div>
                        </div>
                    </div>
                    
                    <!-- Humidity -->
                    <div class="glass-card interactive-card rounded-2xl p-4 sm:p-5 flex flex-col justify-between transition-all duration-300">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="icon-box-3d p-2 rounded-xl">
                                <i data-lucide="droplets" class="w-5 h-5 icon-blue"></i>
                            </div>
                            <span class="text-sm font-medium text-white/70" data-translate="humidity">Humidity</span>
                        </div>
                        <div>
                            <div id="stat-humidity" class="text-xl sm:text-2xl font-bold text-white">--</div>
                            <div class="text-xs text-white/40 mt-1">%</div>
                        </div>
                    </div>

                    <!-- Visibility -->
                    <div class="glass-card interactive-card rounded-2xl p-4 sm:p-5 flex flex-col justify-between transition-all duration-300">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="icon-box-3d p-2 rounded-xl">
                                <i data-lucide="eye" class="w-5 h-5 icon-purple"></i>
                            </div>
                            <span class="text-sm font-medium text-white/70" data-translate="visibility">Visibility</span>
                        </div>
                        <div>
                            <div id="stat-visibility" class="text-xl sm:text-2xl font-bold text-white">--</div>
                            <div class="text-xs text-white/40 mt-1">km</div>
                        </div>
                    </div>

                    <!-- Rain -->
                    <div class="glass-card interactive-card rounded-2xl p-4 sm:p-5 flex flex-col justify-between transition-all duration-300">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="icon-box-3d p-2 rounded-xl">
                                <i data-lucide="umbrella" class="w-5 h-5 icon-blue"></i>
                            </div>
                            <span class="text-sm font-medium text-white/70" data-translate="precip">Precip</span>
                        </div>
                        <div>
                            <div id="stat-rain" class="text-xl sm:text-2xl font-bold text-white">--</div>
                            <div class="text-xs text-white/40 mt-1">mm</div>
                        </div>
                    </div>

                    <!-- UV Index -->
                    <div class="glass-card interactive-card rounded-2xl p-4 sm:p-5 flex flex-col justify-between transition-all duration-300">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="icon-box-3d p-2 rounded-xl">
                                <i data-lucide="sun" class="w-5 h-5 icon-yellow"></i>
                            </div>
                            <span class="text-sm font-medium text-white/70" data-translate="uv">UV Index</span>
                        </div>
                        <div>
                            <div id="stat-uv" class="text-xl sm:text-2xl font-bold text-white">--</div>
                            <div id="stat-uv-text" class="text-xs text-white/40 mt-1">-</div>
                        </div>
                    </div>

                    <!-- Pressure -->
                    <div class="glass-card interactive-card rounded-2xl p-4 sm:p-5 flex flex-col justify-between transition-all duration-300">
                        <div class="flex items-center gap-3 mb-2">
                            <div class="icon-box-3d p-2 rounded-xl">
                                <i data-lucide="gauge" class="w-5 h-5 icon-white"></i>
                            </div>
                            <span class="text-sm font-medium text-white/70" data-translate="pressure">Pressure</span>
                        </div>
                        <div>
                            <div id="stat-pressure" class="text-xl sm:text-2xl font-bold text-white">--</div>
                            <div class="text-xs text-white/40 mt-1">hPa</div>
                        </div>
                    </div>

                    <!-- Sun Times (Double Width) -->
                    <div class="col-span-2 glass-card interactive-card rounded-2xl p-4 sm:p-5 flex items-center justify-between transition-all">
                        <div class="flex flex-col items-center gap-1">
                            <div class="icon-box-3d p-1.5 rounded-lg mb-1">
                                <i data-lucide="sunrise" class="w-5 h-5 icon-yellow"></i>
                            </div>
                            <span class="text-xs text-white/50" data-translate="sunrise">Sunrise</span>
                            <span id="stat-sunrise" class="text-lg font-bold text-white">--:--</span>
                        </div>
                        <div class="h-10 w-px bg-gradient-to-b from-transparent via-white/20 to-transparent"></div>
                        <div class="flex flex-col items-center gap-1">
                            <div class="icon-box-3d p-1.5 rounded-lg mb-1">
                                <i data-lucide="sunset" class="w-5 h-5 icon-yellow"></i>
                            </div>
                            <span class="text-xs text-white/50" data-translate="sunset">Sunset</span>
                            <span id="stat-sunset" class="text-lg font-bold text-white">--:--</span>
                        </div>
                    </div>
                </div>

                <!-- Hourly Scroll -->
                <div class="glass-card rounded-3xl p-6">
                    <h3 class="text-white/90 font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="clock" class="w-5 h-5 text-white/60"></i> <span data-translate="hourly">Hourly Forecast</span>
                    </h3>
                    <div id="hourly-container" class="flex overflow-x-auto pb-4 gap-3 hide-scrollbar snap-x">
                        <!-- Populated via JS -->
                    </div>
                </div>

            </div>

            <!-- Right Column (Chart & Daily) -->
            <div class="space-y-6">
                
                <!-- Chart Section -->
                <div class="glass-card rounded-3xl p-6 w-full">
                    <h3 class="text-white/90 font-semibold mb-4" data-translate="tempTrend">Temperature Trend</h3>
                    <div id="chart-container">
                        <canvas id="tempChart"></canvas>
                    </div>
                </div>

                <!-- 7 Day Forecast -->
                <div class="glass-card rounded-3xl p-6 h-full">
                    <h3 class="text-white/90 font-semibold mb-4 flex items-center gap-2">
                        <i data-lucide="calendar" class="w-5 h-5 text-white/60"></i> <span data-translate="sevenDay">7-Day Forecast</span>
                    </h3>
                    <div id="daily-container" class="space-y-2">
                        <!-- Populated via JS -->
                    </div>
                </div>

                <div class="text-center text-white/30 text-xs">
                    Powered by Open-Meteo • Vanilla JS & Chart.js
                </div>

            </div>
        </div>

        <!-- Error Toast -->
        <div id="error-toast" class="fixed bottom-8 left-1/2 -translate-x-1/2 bg-red-500/90 text-white px-6 py-3 rounded-full shadow-lg backdrop-blur-md transform translate-y-20 transition-transform duration-300 flex items-center gap-2 hidden z-50">
            <i data-lucide="alert-circle" class="w-5 h-5"></i>
            <span id="error-message">Error occurred</span>
        </div>

    </div>

    <script>
        // --- TRANSLATIONS & CONSTANTS ---
        let currentLang = 'en';

        const TRANSLATIONS = {
            en: {
                wind: 'Wind', humidity: 'Humidity', visibility: 'Visibility', precip: 'Precip',
                uv: 'UV Index', pressure: 'Pressure', sunrise: 'Sunrise', sunset: 'Sunset',
                hourly: 'Hourly Forecast', sevenDay: '7-Day Forecast', tempTrend: 'Temperature Trend',
                now: 'Now', today: 'Today', feelsLike: 'Feels like', locate: 'Detecting Location...',
                searchPlaceholder: 'Search city...', high: 'High', moderate: 'Moderate'
            },
            bn: {
                wind: 'বাতাস', humidity: 'আর্দ্রতা', visibility: 'দৃশ্যমানতা', precip: 'বৃষ্টিপাত',
                uv: 'UV সূচক', pressure: 'চাপ', sunrise: 'সূর্যোদয়', sunset: 'সূর্যাস্ত',
                hourly: 'ঘণ্টার পূর্বাভাস', sevenDay: '৭ দিনের পূর্বাভাস', tempTrend: 'তাপমাত্রার প্রবণতা',
                now: 'এখন', today: 'আজ', feelsLike: 'অনুভূত হচ্ছে', locate: 'অবস্থান শনাক্ত করা হচ্ছে...',
                searchPlaceholder: 'শহর খুঁজুন...', high: 'উচ্চ', moderate: 'মাঝারি'
            },
            hi: {
                wind: 'हवा', humidity: 'नमी', visibility: 'दृश्यता', precip: 'वर्षा',
                uv: 'UV सूचकांक', pressure: 'दबाव', sunrise: 'सूर्योदय', sunset: 'सूर्यास्त',
                hourly: 'प्रति घंटा पूर्वानुमान', sevenDay: '7-दिन का पूर्वानुमान', tempTrend: 'तापमान रुझान',
                now: 'अभी', today: 'आज', feelsLike: 'महसूस हो रहा है', locate: 'स्थान का पता लगाया जा रहा है...',
                searchPlaceholder: 'शहर खोजें...', high: 'उच्च', moderate: 'मध्यम'
            }
        };
        
        const WEATHER_CODES = {
            0: { label: { en: 'Clear Sky', bn: 'পরিষ্কার আকাশ', hi: 'साफ आसमान' }, icon: 'sun', color: '#fbbf24' },
            1: { label: { en: 'Mainly Clear', bn: 'মূলত পরিষ্কার', hi: 'मुख्य रूप से साफ' }, icon: 'sun', color: '#fcd34d' },
            2: { label: { en: 'Partly Cloudy', bn: 'আংশিক মেঘলা', hi: 'आंशिक रूप से बादल' }, icon: 'cloud', color: '#e2e8f0' },
            3: { label: { en: 'Overcast', bn: 'মেঘলা', hi: 'बादल छाए हुए' }, icon: 'cloud', color: '#94a3b8' },
            45: { label: { en: 'Fog', bn: 'কুয়াশা', hi: 'कोहरा' }, icon: 'cloud-fog', color: '#cbd5e1' },
            48: { label: { en: 'Fog', bn: 'কুয়াশা', hi: 'कोहरा' }, icon: 'cloud-fog', color: '#cbd5e1' },
            51: { label: { en: 'Drizzle', bn: 'গুঁড়ি গুঁড়ি বৃষ্টি', hi: 'बूंदा बांदी' }, icon: 'cloud-drizzle', color: '#60a5fa' },
            53: { label: { en: 'Moderate Drizzle', bn: 'মাঝারি গুঁড়ি বৃষ্টি', hi: 'मध्यम बूंदा बांदी' }, icon: 'cloud-drizzle', color: '#60a5fa' },
            55: { label: { en: 'Dense Drizzle', bn: 'ঘন গুঁড়ি বৃষ্টি', hi: 'भारी बूंदा बांदी' }, icon: 'cloud-drizzle', color: '#3b82f6' },
            61: { label: { en: 'Slight Rain', bn: 'হালকা বৃষ্টি', hi: 'हल्की बारिश' }, icon: 'cloud-rain', color: '#60a5fa' },
            63: { label: { en: 'Rain', bn: 'বৃষ্টি', hi: 'बारिश' }, icon: 'cloud-rain', color: '#3b82f6' },
            65: { label: { en: 'Heavy Rain', bn: 'ভারী বৃষ্টি', hi: 'भारी बारिश' }, icon: 'cloud-rain', color: '#2563eb' },
            71: { label: { en: 'Snow', bn: 'তুষারপাত', hi: 'बर्फबारी' }, icon: 'snowflake', color: '#ffffff' },
            73: { label: { en: 'Moderate Snow', bn: 'মাঝারি তুষারপাত', hi: 'मध्यम बर्फबारी' }, icon: 'snowflake', color: '#ffffff' },
            75: { label: { en: 'Heavy Snow', bn: 'ভারী তুষারপাত', hi: 'भारी बर्फबारी' }, icon: 'snowflake', color: '#ffffff' },
            95: { label: { en: 'Thunderstorm', bn: 'বজ্রঝড়', hi: 'आंधी तूफान' }, icon: 'cloud-lightning', color: '#a78bfa' },
            96: { label: { en: 'Thunderstorm', bn: 'বজ্রঝড়', hi: 'आंधी तूफान' }, icon: 'cloud-lightning', color: '#a78bfa' },
            99: { label: { en: 'Heavy Thunderstorm', bn: 'ভারী বজ্রঝড়', hi: 'भारी आंधी तूफान' }, icon: 'cloud-lightning', color: '#a78bfa' },
        };

        // --- PWA MANIFEST GENERATION ---
        const manifest = {
            name: "Liquid Weather",
            short_name: "Weather",
            description: "Aesthetic Weather App",
            start_url: "./index.html",
            display: "standalone",
            background_color: "#0f172a",
            theme_color: "#0f172a",
            icons: [
                {
                    src: "https://cdn.jsdelivr.net/npm/lucide-static@0.469.0/icons/cloud-sun.svg",
                    sizes: "192x192",
                    type: "image/svg+xml"
                }
            ]
        };
        const manifestBlob = new Blob([JSON.stringify(manifest)], {type: 'application/json'});
        document.getElementById('manifest-placeholder').href = URL.createObjectURL(manifestBlob);

        // --- DOM Elements ---
        let tempChart = null;
        const els = {
            bg: document.getElementById('bg-layer'),
            content: document.getElementById('main-content'),
            location: document.getElementById('location-name'),
            date: document.getElementById('current-date'),
            time: document.getElementById('current-time'), // New time element
            searchInput: document.getElementById('search-input'),
            searchForm: document.getElementById('search-form'),
            // Added searchIcon wrapper selector
            searchIcon: document.getElementById('search-icon-wrapper'), 
            loader: document.getElementById('search-loader'),
            errorToast: document.getElementById('error-toast'),
            errorMsg: document.getElementById('error-message'),
            locateBtn: document.getElementById('locate-btn'),
            installBtn: document.getElementById('install-btn'),
            langSelect: document.getElementById('lang-select'),
            // Current Weather
            temp: document.getElementById('current-temp'),
            desc: document.getElementById('weather-desc'),
            dot: document.getElementById('weather-dot'),
            maxTemp: document.getElementById('max-temp'),
            minTemp: document.getElementById('min-temp'),
            summary: document.getElementById('summary-text'),
            // Animation Elements
            scene: document.getElementById('weather-scene'),
            sun: document.getElementById('anim-sun'),
            moon: document.getElementById('anim-moon'), // Added Moon
            cloud: document.getElementById('anim-cloud'),
            rain: document.getElementById('anim-rain'),
            snow: document.getElementById('anim-snow'), // Added Snow
            thunder: document.getElementById('anim-thunder'), // Added Thunder
            // Stats
            wind: document.getElementById('stat-wind'),
            humidity: document.getElementById('stat-humidity'),
            visibility: document.getElementById('stat-visibility'),
            rainStat: document.getElementById('stat-rain'),
            uv: document.getElementById('stat-uv'),
            uvText: document.getElementById('stat-uv-text'),
            pressure: document.getElementById('stat-pressure'),
            sunrise: document.getElementById('stat-sunrise'),
            sunset: document.getElementById('stat-sunset'),
            // Lists
            hourly: document.getElementById('hourly-container'),
            daily: document.getElementById('daily-container'),
            chartCtx: document.getElementById('tempChart').getContext('2d')
        };

        let weatherDataCache = null;
        let locationNameCache = "";

        // --- Core Logic ---

        function init() {
            lucide.createIcons();
            
            // Start Clock
            setInterval(updateTime, 1000);
            updateTime();

            // Listeners
            els.locateBtn.addEventListener('click', () => triggerLocation(true));
            els.searchForm.addEventListener('submit', handleSearch);
            els.langSelect.addEventListener('change', (e) => {
                currentLang = e.target.value;
                updateTime(); // Update time immediately on language change
                if (weatherDataCache) updateUI(weatherDataCache, locationNameCache);
            });

            // PWA Install Prompt
            let deferredPrompt;
            window.addEventListener('beforeinstallprompt', (e) => {
                e.preventDefault();
                deferredPrompt = e;
                els.installBtn.classList.remove('hidden');
                
                els.installBtn.addEventListener('click', async () => {
                    els.installBtn.classList.add('hidden');
                    deferredPrompt.prompt();
                    const { outcome } = await deferredPrompt.userChoice;
                    deferredPrompt = null;
                });
            });

            // Initial Load
            triggerLocation(false);
        }

        function updateTime() {
            const now = new Date();
            const locale = currentLang === 'bn' ? 'bn-BD' : currentLang === 'hi' ? 'hi-IN' : 'en-US';
            
            // Update Time
            els.time.textContent = now.toLocaleTimeString(locale, { 
                hour: '2-digit', minute: '2-digit', second: '2-digit' 
            });
            
            // Update Date
            els.date.textContent = now.toLocaleDateString(locale, { 
                weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' 
            });
        }

        // --- TRANSLATION HELPER ---
        function t(key) {
            return TRANSLATIONS[currentLang][key] || key;
        }
        
        function updateStaticText() {
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                el.textContent = t(key);
            });
            els.searchInput.placeholder = t('searchPlaceholder');
        }

        function triggerLocation(isManual) {
            if (isManual) {
                els.location.textContent = t('locate');
                showLoader(true);
            }

            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        fetchWeather(pos.coords.latitude, pos.coords.longitude, 'Your Location');
                        showLoader(false);
                    },
                    (err) => {
                        console.warn("Geo Error:", err);
                        if (isManual) {
                            showError('Permission denied or unavailable.');
                            showLoader(false);
                            els.location.textContent = "Location Denied";
                        } else {
                            fetchWeather(22.5726, 88.3639, 'Kolkata, India'); // Default nearby fallback for Bengali/Hindi context
                        }
                    },
                    { timeout: 10000, enableHighAccuracy: true }
                );
            } else {
                if(isManual) showError('Geolocation not supported');
                fetchWeather(22.5726, 88.3639, 'Kolkata, India');
            }
        }

        async function handleSearch(e) {
            e.preventDefault();
            const query = els.searchInput.value.trim();
            if(!query) return;

            showLoader(true);
            try {
                const res = await fetch(`https://geocoding-api.open-meteo.com/v1/search?name=${query}&count=1&language=en&format=json`);
                const data = await res.json();
                
                if (data.results && data.results.length > 0) {
                    const { latitude, longitude, name, country } = data.results[0];
                    await fetchWeather(latitude, longitude, `${name}, ${country}`);
                    els.searchInput.value = '';
                } else {
                    showError('Location not found');
                }
            } catch (err) {
                showError('Search failed. Try again.');
            } finally {
                showLoader(false);
            }
        }

        async function fetchWeather(lat, lon, name) {
            try {
                els.content.style.opacity = '0.5';

                const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current=temperature_2m,relative_humidity_2m,apparent_temperature,is_day,precipitation,rain,showers,snowfall,weather_code,cloud_cover,wind_speed_10m,surface_pressure&hourly=temperature_2m,weather_code,visibility&daily=weather_code,temperature_2m_max,temperature_2m_min,sunrise,sunset,uv_index_max,precipitation_sum&timezone=auto`;
                
                const res = await fetch(url);
                if (!res.ok) throw new Error('API Error');
                const data = await res.json();

                weatherDataCache = data;
                locationNameCache = name;
                
                updateUI(data, name);
                
                els.content.style.opacity = '1';
            } catch (err) {
                console.error(err);
                showError('Failed to load weather data');
                els.content.style.opacity = '1';
            }
        }

        function updateUI(data, name) {
            const current = data.current;
            const daily = data.daily;
            const hourly = data.hourly;

            // Update Translations first
            updateStaticText();
            
            updateTheme(current.is_day, current.weather_code);
            els.location.textContent = name; // City names usually kept in English or from API, manual translation hard without API support

            const codeData = WEATHER_CODES[current.weather_code] || WEATHER_CODES[0];
            els.temp.textContent = `${Math.round(current.temperature_2m)}°`;
            els.desc.textContent = codeData.label[currentLang] || codeData.label.en;
            els.dot.className = `w-2 h-2 rounded-full animate-pulse ${current.is_day ? 'bg-yellow-400' : 'bg-blue-300'} box-shadow-glow`;
            
            // --- UPDATED ANIMATION STATE CONTROL ---
            const isDay = current.is_day === 1;
            const code = current.weather_code;
            
            // Reset all states first
            els.sun.style.opacity = '0';
            els.sun.previousElementSibling.style.opacity = '0'; // Sun Aura
            els.moon.style.opacity = '0';
            els.cloud.classList.remove('state-visible'); els.cloud.classList.add('state-hidden');
            els.rain.style.opacity = '0';
            els.snow.style.opacity = '0';
            els.thunder.style.opacity = '0';

            // 1. Sun vs Moon Logic
            if (code <= 2) { // Only show celestial bodies if not completely overcast/stormy
                if (isDay) {
                    els.sun.style.opacity = '1';
                    els.sun.previousElementSibling.style.opacity = '1';
                } else {
                    els.moon.style.opacity = '1';
                }
            }

            // 2. Cloud Logic
            if (code >= 2) { // Partly cloudy or worse
                els.cloud.classList.remove('state-hidden');
                els.cloud.classList.add('state-visible');
            }

            // 3. Precipitation Logic
            // Rain: 51-67, 80-82
            if ((code >= 51 && code <= 67) || (code >= 80 && code <= 82)) {
                els.rain.style.opacity = '1';
            }
            // Snow: 71-77, 85-86
            if ((code >= 71 && code <= 77) || (code >= 85 && code <= 86)) {
                els.snow.style.opacity = '1';
            }
            // Thunder: 95-99
            if (code >= 95) {
                els.thunder.style.opacity = '1';
                // Thunder usually implies rain too, but check code
                if (code >= 96) els.rain.style.opacity = '1'; 
            }

            els.maxTemp.textContent = `${Math.round(daily.temperature_2m_max[0])}°`;
            els.minTemp.textContent = `${Math.round(daily.temperature_2m_min[0])}°`;
            
            const feelsLikeText = t('feelsLike');
            const windText = t('wind');
            els.summary.textContent = `${feelsLikeText} ${Math.round(current.apparent_temperature)}°. ${windText} ${Math.round(current.wind_speed_10m)} km/h.`;

            // Stats
            els.wind.textContent = Math.round(current.wind_speed_10m);
            els.humidity.textContent = current.relative_humidity_2m;
            els.visibility.textContent = (hourly.visibility[0] / 1000).toFixed(1);
            els.rainStat.textContent = daily.precipitation_sum[0];
            els.uv.textContent = daily.uv_index_max[0];
            els.uvText.textContent = daily.uv_index_max[0] > 5 ? t('high') : t('moderate');
            els.pressure.textContent = Math.round(current.surface_pressure);
            
            // Format time based on locale
            const timeOptions = { hour: '2-digit', minute: '2-digit' };
            const locale = currentLang === 'bn' ? 'bn-BD' : currentLang === 'hi' ? 'hi-IN' : 'en-US';
            
            els.sunrise.textContent = new Date(daily.sunrise[0]).toLocaleTimeString(locale, timeOptions);
            els.sunset.textContent = new Date(daily.sunset[0]).toLocaleTimeString(locale, timeOptions);

            renderHourly(hourly, locale);
            renderDaily(daily, locale);
            renderChart(hourly);

            lucide.createIcons();
        }

        // --- UPDATED THEME LOGIC ---
        function updateTheme(isDay, code) {
            // Remove previous classes
            els.bg.className = 'liquid-bg';
            
            let theme = 'day-clear'; // default

            if (isDay) {
                // Day Themes
                if (code <= 1) theme = 'day-clear';
                else if (code <= 3) theme = 'day-cloudy';
                else if (code >= 45 && code <= 48) theme = 'day-fog';
                else if (code >= 51 && code <= 67) theme = 'day-rain';
                else if (code >= 71 && code <= 77) theme = 'day-snow';
                else if (code >= 80 && code <= 82) theme = 'day-rain';
                else if (code >= 85 && code <= 86) theme = 'day-snow';
                else if (code >= 95) theme = 'day-thunder';
            } else {
                // Night Themes
                if (code <= 1) theme = 'night-clear';
                else if (code <= 3) theme = 'night-cloudy';
                else if (code >= 45 && code <= 48) theme = 'night-fog';
                else if (code >= 51 && code <= 67) theme = 'night-rain';
                else if (code >= 71 && code <= 77) theme = 'night-snow';
                else if (code >= 80 && code <= 82) theme = 'night-rain';
                else if (code >= 85 && code <= 86) theme = 'night-snow';
                else if (code >= 95) theme = 'night-thunder';
            }
            
            els.bg.classList.add(theme);
        }

        function renderHourly(hourly, locale) {
            els.hourly.innerHTML = '';
            for(let i = 0; i < 24; i++) {
                const dateObj = new Date(hourly.time[i]);
                // Basic check for "Now" vs hour
                const time = i === 0 ? t('now') : dateObj.getHours() + ':00'; // Simplifying time for space
                
                const temp = Math.round(hourly.temperature_2m[i]);
                const code = hourly.weather_code[i];
                const icon = (WEATHER_CODES[code] || WEATHER_CODES[0]).icon;

                const el = document.createElement('div');
                el.className = `flex-shrink-0 w-20 flex flex-col items-center gap-3 p-3 rounded-2xl transition-all ${i === 0 ? 'bg-white/20 ring-1 ring-white/30 shadow-lg' : ''}`;
                el.innerHTML = `
                    <span class="text-sm text-white/70">${time}</span>
                    <i data-lucide="${icon}" class="w-6 h-6 text-white/90 drop-shadow-md"></i>
                    <span class="text-lg font-bold">${temp}°</span>
                `;
                els.hourly.appendChild(el);
            }
        }

        function renderDaily(daily, locale) {
            els.daily.innerHTML = '';
            for(let i = 0; i < 7; i++) {
                const dateObj = new Date(daily.time[i]);
                const dayLabel = i === 0 ? t('today') : dateObj.toLocaleDateString(locale, { weekday: 'short' });
                const max = Math.round(daily.temperature_2m_max[i]);
                const min = Math.round(daily.temperature_2m_min[i]);
                const code = daily.weather_code[i];
                const icon = (WEATHER_CODES[code] || WEATHER_CODES[0]).icon;

                const el = document.createElement('div');
                el.className = 'flex items-center justify-between p-3 rounded-xl transition-colors cursor-default';
                el.innerHTML = `
                    <span class="text-white font-medium w-16">${dayLabel}</span>
                    <div class="flex items-center gap-2 flex-1 justify-center">
                        <i data-lucide="${icon}" class="w-5 h-5 text-white/80 drop-shadow"></i>
                    </div>
                    <div class="flex items-center gap-4 w-24 justify-end">
                        <span class="text-white font-bold">${max}°</span>
                        <span class="text-white/50 font-medium">${min}°</span>
                    </div>
                `;
                els.daily.appendChild(el);
            }
        }

        function renderChart(hourly) {
            const labels = hourly.time.slice(0, 24).map(t => new Date(t).getHours() + ':00');
            const dataPoints = hourly.temperature_2m.slice(0, 24);

            if (tempChart) tempChart.destroy();

            const gradient = els.chartCtx.createLinearGradient(0, 0, 0, 400);
            gradient.addColorStop(0, 'rgba(255, 255, 255, 0.5)');
            gradient.addColorStop(1, 'rgba(255, 255, 255, 0)');

            tempChart = new Chart(els.chartCtx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Temp (°C)',
                        data: dataPoints,
                        borderColor: '#ffffff',
                        borderWidth: 3,
                        backgroundColor: gradient,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#ffffff',
                        pointBorderColor: '#fff',
                        pointRadius: 0,
                        pointHoverRadius: 6
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(0,0,0,0.8)',
                            titleColor: '#fff',
                            bodyColor: '#fff',
                            padding: 12,
                            displayColors: false,
                            callbacks: { label: (context) => `${context.parsed.y}°C` }
                        }
                    },
                    scales: {
                        x: { display: false },
                        y: { display: false, min: Math.min(...dataPoints) - 5, max: Math.max(...dataPoints) + 5 }
                    }
                }
            });
        }

        function showLoader(show) {
            if(show) {
                els.loader.classList.remove('hidden');
                // Use the safe wrapper ID instead of trying to select the potentially replaced 'i' tag
                els.searchIcon.classList.add('hidden');
            } else {
                els.loader.classList.add('hidden');
                els.searchIcon.classList.remove('hidden');
            }
        }

        function showError(msg) {
            els.errorMsg.textContent = msg;
            els.errorToast.classList.remove('hidden', 'translate-y-20');
            setTimeout(() => {
                els.errorToast.classList.add('translate-y-20');
                setTimeout(() => els.errorToast.classList.add('hidden'), 300);
            }, 3000);
        }

        init();

    </script>
</body>
</html>