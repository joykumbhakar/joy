<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="description"
        content="RealStore - The premium destination for luxury digital assets, electronics, and fashion. Secure, fast, and exclusive.">
    <meta name="keywords" content="ecommerce, luxury, premium, shopping, marketplace, google material design">
    <meta name="author" content="RealStore Inc.">

    <!-- Open Graph / Social -->
    <meta property="og:type" content="website">
    <meta property="og:title" content="RealStore | Premium Material Shop">
    <meta property="og:description" content="Experience luxury redefined. Shop the exclusive collection now.">
    <meta property="og:image"
        content="https://images.unsplash.com/photo-1556742049-0cfed4f7a07d?auto=format&fit=crop&w=1200&q=80">

    <title>RealStore</title>

    <!-- Dependencies -->
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/@lottiefiles/lottie-player@latest/dist/lottie-player.js"></script>
    <link
        href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&family=Google+Sans:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/swiper@11/swiper-bundle.min.css">

    <!-- Firebase SDKs (Modular Compat) -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>

    <style>
        :root {
            /* Core Palette - Google Blue */
            --md-sys-color-primary: #0b57d0;
            --md-sys-color-on-primary: #ffffff;
            --md-sys-color-primary-container: #d3e3fd;
            --md-sys-color-on-primary-container: #041e49;

            --md-sys-color-secondary: #00639b;
            --md-sys-color-on-secondary: #ffffff;
            --md-sys-color-secondary-container: #c2e7ff;
            --md-sys-color-on-secondary-container: #001d35;

            --md-sys-color-tertiary: #146c2e;
            --md-sys-color-tertiary-container: #c4eed0;

            --md-sys-color-error: #ba1a1a;
            --md-sys-color-on-error: #ffffff;
            --md-sys-color-error-container: #ffdad6;

            /* Surfaces */
            --md-sys-color-background: #f8f9fa;
            --md-sys-color-on-background: #1f1f1f;

            --md-sys-color-surface: #ffffff;
            --md-sys-color-on-surface: #1f1f1f;
            --md-sys-color-surface-variant: #e1e2e6;
            --md-sys-color-on-surface-variant: #44474f;

            --md-sys-color-outline: #747775;
            --md-sys-color-outline-variant: #c4c7c5;

            /* Typography */
            --font-display: 'Google Sans', 'Roboto', sans-serif;
            --font-body: 'Roboto', sans-serif;

            /* Shape */
            --radius-full: 9999px;
            --radius-xl: 28px;
            --radius-lg: 16px;
            --radius-md: 12px;
            --radius-sm: 8px;

            /* Elevation */
            --elevation-1: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 1px 3px 1px rgba(0, 0, 0, 0.15);
            --elevation-2: 0px 1px 2px rgba(0, 0, 0, 0.3), 0px 2px 6px 2px rgba(0, 0, 0, 0.15);
            --elevation-3: 0px 4px 8px 3px rgba(0, 0, 0, 0.15), 0px 1px 3px 0px rgba(0, 0, 0, 0.3);

            --transition: all 0.2s cubic-bezier(0.2, 0.0, 0, 1.0);

            /* Layout */
            --header-height: 64px;
            --max-width: 1200px;
        }

        /* Dark Mode Tokens */
        body.dark-mode {
            --md-sys-color-primary: #a8c7fa;
            --md-sys-color-on-primary: #002f65;
            --md-sys-color-primary-container: #00478f;
            --md-sys-color-on-primary-container: #d3e3fd;

            --md-sys-color-secondary: #7fcfff;
            --md-sys-color-on-secondary: #003355;
            --md-sys-color-secondary-container: #004b73;
            --md-sys-color-on-secondary-container: #c2e7ff;

            --md-sys-color-background: #111318;
            --md-sys-color-on-background: #e2e2e6;

            --md-sys-color-surface: #1e1f20;
            --md-sys-color-on-surface: #e2e2e6;
            --md-sys-color-surface-variant: #44474f;
            --md-sys-color-on-surface-variant: #c4c7c5;

            --md-sys-color-outline: #8e9099;
        }

        /* --- BASE --- */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: var(--font-body);
            background-color: var(--md-sys-color-background);
            color: var(--md-sys-color-on-background);
            overflow-x: hidden;
            min-height: 100vh;
            transition: background-color 0.3s ease, color 0.3s ease;
            padding-bottom: 90px;
        }

        @media (min-width: 769px) {
            body {
                padding-bottom: 0;
            }
        }

        h1,
        h2,
        h3,
        h4,
        h5,
        h6 {
            font-family: var(--font-display);
            font-weight: 400;
            color: var(--md-sys-color-on-surface);
        }

        /* --- COMPONENTS --- */
        .card-panel {
            background-color: var(--md-sys-color-surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--elevation-1);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 0 24px;
            height: 40px;
            border-radius: var(--radius-full);
            font-family: var(--font-display);
            font-weight: 500;
            font-size: 14px;
            letter-spacing: 0.1px;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
            white-space: nowrap;
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .btn-primary {
            background-color: var(--md-sys-color-primary);
            color: var(--md-sys-color-on-primary);
        }

        .btn-primary:hover:not(:disabled) {
            box-shadow: var(--elevation-1);
            background-image: linear-gradient(rgba(255, 255, 255, 0.08), rgba(255, 255, 255, 0.08));
        }

        .btn-secondary {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
        }

        .btn-secondary:hover:not(:disabled) {
            box-shadow: var(--elevation-1);
            filter: brightness(0.95);
        }

        .btn-ghost {
            background: transparent;
            color: var(--md-sys-color-primary);
            padding: 0 16px;
        }

        .btn-ghost:hover:not(:disabled) {
            background-color: var(--md-sys-color-surface-variant);
        }

        .btn-icon {
            width: 40px;
            height: 40px;
            padding: 0;
            border-radius: 50%;
            color: var(--md-sys-color-on-surface-variant);
        }

        .btn-sm {
            padding: 0 16px;
            height: 32px;
            font-size: 12px;
        }

        .btn-lg {
            padding: 0 32px;
            height: 56px;
            font-size: 16px;
        }

        input,
        select,
        textarea {
            width: 100%;
            padding: 13px 16px;
            background-color: transparent;
            border: 1px solid var(--md-sys-color-outline);
            border-radius: var(--radius-sm);
            font-family: var(--font-body);
            font-size: 16px;
            outline: none;
            color: var(--md-sys-color-on-surface);
            transition: var(--transition);
        }

        input:focus,
        select:focus,
        textarea:focus {
            border-color: var(--md-sys-color-primary);
            border-width: 2px;
            padding: 12px 15px;
        }

        /* --- LAYOUT --- */
        .navbar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: var(--header-height);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 24px;
            background-color: var(--md-sys-color-surface);
            color: var(--md-sys-color-on-surface);
            box-shadow: var(--elevation-1);
        }

        .logo {
            font-family: var(--font-display);
            font-weight: 500;
            font-size: 22px;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--md-sys-color-on-surface);
            cursor: pointer;
        }

        .container {
            max-width: var(--max-width);
            margin: 0 auto;
            padding: 90px 24px 40px 24px;
        }

        /* --- VIEWS --- */
        .view {
            display: none;
            animation: fadeUp 0.4s cubic-bezier(0.2, 0.0, 0, 1.0);
        }

        .view.active {
            display: block;
        }

        @keyframes fadeUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* --- HERO & BANNER --- */
        .hero {
            position: relative;
            margin-bottom: 48px;
            border-radius: var(--radius-xl);
            overflow: hidden;
            background-color: var(--md-sys-color-surface-variant);
            box-shadow: var(--elevation-1);
        }

        .hero-banner-container {
            width: 100%;
            height: 300px;
            position: relative;
        }

        .hero-banner-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            object-position: center;
        }

        .hero-overlay {
            position: absolute;
            inset: 0;
            background: linear-gradient(to bottom, transparent 40%, rgba(0, 0, 0, 0.6));
            display: flex;
            align-items: flex-end;
            padding: 24px;
        }

        /* Floating Search Bar overlapping banner */
        .search-container-floating {
            position: relative;
            margin-top: -28px;
            /* Half height overlap */
            padding: 0 16px;
            z-index: 10;
        }

        .search-bar {
            max-width: 720px;
            margin: 0 auto;
            position: relative;
            height: 56px;
            background-color: var(--md-sys-color-surface);
            border-radius: 28px;
            box-shadow: var(--elevation-2);
            display: flex;
            align-items: center;
        }

        .search-bar input {
            height: 100%;
            border-radius: 28px;
            padding-left: 56px;
            padding-right: 24px;
            border: none;
            background: transparent;
            width: 100%;
        }

        .search-bar input:focus {
            box-shadow: none;
            border: none;
            padding: 12px 16px 12px 56px;
        }

        .search-bar svg {
            position: absolute;
            left: 20px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--md-sys-color-on-surface-variant);
        }

        /* Chips */
        .chip-container {
            display: flex;
            gap: 8px;
            justify-content: center;
            flex-wrap: wrap;
            margin-top: 32px;
            margin-bottom: 40px;
        }

        .chip {
            height: 32px;
            padding: 0 16px;
            border-radius: 8px;
            border: 1px solid var(--md-sys-color-outline);
            background: transparent;
            color: var(--md-sys-color-on-surface-variant);
            font-family: var(--font-display);
            font-size: 14px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: var(--transition);
        }

        .chip:hover {
            background-color: rgba(29, 27, 32, 0.08);
        }

        .chip.active {
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            border-color: transparent;
        }

        /* --- PRODUCT GRID --- */
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 24px;
        }

        .product-card {
            background-color: var(--md-sys-color-surface);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--elevation-1);
            transition: var(--transition);
            cursor: pointer;
            position: relative;
        }

        .product-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--elevation-2);
        }

        .img-box {
            height: 260px;
            width: 100%;
            background-color: var(--md-sys-color-surface-variant);
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
        }

        .img-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.5s;
        }

        .product-card:hover .img-box img {
            transform: scale(1.05);
        }

        .info-box {
            padding: 16px;
        }

        .p-title {
            font-weight: 500;
            font-size: 16px;
            margin-bottom: 4px;
            color: var(--md-sys-color-on-surface);
        }

        .p-cat {
            font-size: 12px;
            color: var(--md-sys-color-primary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .p-price {
            font-size: 18px;
            color: var(--md-sys-color-on-surface);
            font-weight: 400;
        }

        .fab-mini {
            position: absolute;
            bottom: 12px;
            right: 12px;
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background-color: var(--md-sys-color-primary-container);
            color: var(--md-sys-color-on-primary-container);
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--elevation-1);
            border: none;
            cursor: pointer;
            transition: var(--transition);
        }

        .fab-mini:hover {
            box-shadow: var(--elevation-2);
            transform: scale(1.05);
        }

        /* --- PRODUCT DETAIL --- */
        .detail-layout {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 48px;
            align-items: start;
        }

        .detail-img {
            width: 100%;
            border-radius: 24px;
            height: auto;
            aspect-ratio: 1/1;
            object-fit: cover;
            background-color: var(--md-sys-color-surface-variant);
        }

        .detail-info {
            padding-top: 10px;
        }

        .detail-info h1 {
            font-family: var(--font-display);
            font-size: 45px;
            line-height: 52px;
            margin-bottom: 16px;
        }

        .detail-price {
            font-size: 32px;
            font-weight: 400;
            color: var(--md-sys-color-primary);
            margin-bottom: 32px;
        }

        /* --- TRACKING TIMELINE (Amazon Style) --- */
        .tracking-timeline {
            display: flex;
            justify-content: space-between;
            position: relative;
            margin: 30px 0;
        }

        .tracking-timeline::before {
            content: '';
            position: absolute;
            top: 12px;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--md-sys-color-surface-variant);
            z-index: 0;
        }

        .tracking-step {
            position: relative;
            z-index: 1;
            text-align: center;
            flex: 1;
        }

        .step-dot {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            background: var(--md-sys-color-surface-variant);
            border: 4px solid var(--md-sys-color-surface);
            margin: 0 auto 10px auto;
            transition: all 0.3s ease;
        }

        .tracking-step.active .step-dot {
            background: var(--md-sys-color-tertiary);
        }

        .tracking-step.completed .step-dot {
            background: var(--md-sys-color-tertiary);
        }

        .step-label {
            font-size: 12px;
            color: var(--md-sys-color-on-surface-variant);
            font-weight: 500;
        }

        .tracking-step.active .step-label {
            color: var(--md-sys-color-tertiary);
            font-weight: 700;
        }

        /* --- THANK YOU OVERLAY --- */
        .thank-you-overlay {
            position: fixed;
            inset: 0;
            background: var(--md-sys-color-surface);
            z-index: 5000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease;
        }

        .thank-you-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .thank-you-content {
            text-align: center;
            padding: 40px;
            max-width: 500px;
        }

        /* --- CART SIDEBAR --- */
        .drawer {
            position: fixed;
            top: 0;
            right: 0;
            width: 100%;
            max-width: 360px;
            height: 100%;
            background-color: var(--md-sys-color-surface);
            z-index: 2000;
            transform: translateX(100%);
            transition: transform 0.3s cubic-bezier(0.2, 0, 0, 1);
            display: flex;
            flex-direction: column;
            border-top-left-radius: 28px;
            border-bottom-left-radius: 28px;
            box-shadow: var(--elevation-3);
        }

        .drawer.open {
            transform: translateX(0);
        }

        .drawer-header {
            padding: 20px 24px;
            font-size: 22px;
            font-family: var(--font-display);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .drawer-content {
            flex: 1;
            overflow-y: auto;
            padding: 0 24px;
        }

        .drawer-footer {
            padding: 24px;
            background-color: var(--md-sys-color-surface-variant);
        }

        /* --- MODAL --- */
        .dialog-scrim {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 3000;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s;
        }

        .dialog-scrim.open {
            opacity: 1;
            pointer-events: auto;
        }

        .dialog {
            background-color: var(--md-sys-color-surface);
            padding: 24px;
            border-radius: 28px;
            width: 90%;
            max-width: 400px;
            box-shadow: var(--elevation-3);
            transform: scale(0.9);
            transition: transform 0.2s;
            max-height: 85vh;
            overflow-y: auto;
        }

        .dialog-scrim.open .dialog {
            transform: scale(1);
        }

        /* --- TOAST --- */
        .snackbar {
            position: fixed;
            bottom: 100px;
            left: 24px;
            /* Adjusted for bottom nav on mobile */
            background-color: #313033;
            color: #f4eff4;
            padding: 14px 16px;
            border-radius: 4px;
            font-size: 14px;
            box-shadow: var(--elevation-2);
            z-index: 4000;
            display: none;
            align-items: center;
            justify-content: space-between;
            min-width: 300px;
        }

        /* --- MOBILE BOTTOM NAVIGATION (Google Style) --- */
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 80px;
            /* Increased height for floating button overlap */
            background: transparent;
            z-index: 1000;
            display: none;
            /* Hidden on desktop */
            pointer-events: none;
            /* Allows clicks to pass through the empty space above the bar */
        }

        .bottom-nav-bar {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            height: 64px;
            background-color: var(--md-sys-color-surface);
            border-top: 1px solid var(--md-sys-color-outline-variant);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 12px;
            pointer-events: auto;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.05);
        }

        .nav-item {
            flex: 1;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--md-sys-color-on-surface-variant);
            text-decoration: none;
            cursor: pointer;
            gap: 4px;
        }

        .nav-item.active {
            color: var(--md-sys-color-primary);
        }

        .nav-item.active i {
            /* Active indicator pill style could go here */
            background-color: var(--md-sys-color-secondary-container);
            color: var(--md-sys-color-on-secondary-container);
            padding: 2px 16px;
            border-radius: 16px;
        }

        .nav-item i {
            transition: all 0.2s ease;
        }

        .nav-item span {
            font-size: 12px;
            font-weight: 500;
        }

        /* Center Floating Action Button (FAB) Style */
        .nav-center-wrapper {
            position: relative;
            width: 60px;
            display: flex;
            justify-content: center;
            pointer-events: auto;
        }

          .nav-fab-shopping {
            left: 50%;
            transform: translateX(-50%);
            position: absolute;
            bottom: 20px; /* Floats above the bar */
            width: 64px;
            height: 64px;
            background-color: #000000; /* Black Circle as requested */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 12px rgba(0,0,0,0.3);
            border: 4px solid var(--md-sys-color-background); /* Matches background for cutout effect */
            cursor: pointer;
            transition: transform 0.2s ease;
            z-index: 5;
        }

        .nav-fab-shopping:active {
            transform: scale(0.95);
        }

        .dark-mode .nav-fab-shopping {
            border-color: var(--md-sys-color-background);
            background-color: var(--md-sys-color-primary);
            /* Use primary in dark mode for visibility */
            color: var(--md-sys-color-on-primary);
        }

        /* Admin FAB - Move up on mobile to avoid nav */
        #admin-fab {
            bottom: 90px;
        }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .hero h1 {
                font-size: 44px;
                line-height: 52px;
            }

            .grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .detail-layout {
                grid-template-columns: 1fr;
                gap: 24px;
            }

            .drawer {
                max-width: 100%;
                border-radius: 0;
            }

            /* Hide top navbar elements on mobile */
            .navbar .btn-icon {
                display: none;
            }

            /* Hide generic top icons */
            .navbar .logo {
                margin: 0 auto;
            }

            /* Center logo */

            /* Show bottom nav */
            .bottom-nav {
                display: block;
            }
        }

        .loader {
            border: 3px solid rgba(0, 0, 0, 0.1);
            border-left-color: var(--md-sys-color-primary);
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>

    <!-- Navbar (Desktop) -->
    <nav class="navbar">
        <div class="logo" onclick="app.router('home')" style="font-family: 'Product Sans', sans-serif;">
            <i data-lucide="gem" style="color: var(--md-sys-color-primary); margin-right: 8px;"></i> RealStore
        </div>
        <!-- Desktop Only Actions -->
        <div style="display: flex; gap: 8px;" class="hidden md:flex">
            <button class="btn btn-icon btn-ghost" onclick="app.router('wishlist')" aria-label="Wishlist"><i
                    data-lucide="heart"></i></button>
            <button class="btn btn-icon btn-ghost" onclick="app.toggleCart()" aria-label="Cart">
                <div style="position:relative">
                    <i data-lucide="shopping-bag"></i>
                    <span id="cart-badge-desktop"
                        style="position:absolute; top:-2px; right:-2px; width:8px; height:8px; background:var(--md-sys-color-error); border-radius:50%; display:none"></span>
                </div>
            </button>
            <button class="btn btn-icon btn-ghost" id="auth-btn-desktop" onclick="app.openAuth()" aria-label="Account">
                <i data-lucide="user"></i>
            </button>
        </div>
    </nav>

    <!-- Toast Container -->
    <div class="toast-container" id="toast-container"></div>

    <!-- Thank You Overlay -->
    <div id="thank-you-overlay" class="thank-you-overlay">
        <div class="thank-you-content">
            <lottie-player src="https://assets10.lottiefiles.com/packages/lf20_yom6uvgj.json" background="transparent"
                speed="1" style="width: 300px; height: 300px; margin: 0 auto;" autoplay></lottie-player>
            <h1 style="color: var(--md-sys-color-primary);">Order Placed!</h1>
            <p style="color: var(--md-sys-color-on-surface-variant); margin-top: 10px;">Your order has been successfully
                placed. We will notify you once it ships.</p>
            <button class="btn btn-primary btn-lg" style="margin-top: 30px;" onclick="app.closeThankYou()">Track
                Order</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="container">

        <!-- HOME -->
        <div id="view-home" class="view active">
            <!-- Hero with Banner Image -->
            <div class="hero">
                <div class="hero-banner-container">
                    <!-- Banner Image -->
                    <img src="https://images.unsplash.com/photo-1607082348824-0a96f2a4b9da?auto=format&fit=crop&w=1200&q=80"
                        alt="Welcome Banner" class="hero-banner-img"
                        onerror="this.src='https://via.placeholder.com/1200x300?text=RealStore+Banner'">
                </div>
            </div>

            <!-- Floating Search Bar -->
            <div class="search-container-floating">
                <div class="search-bar">
                    <i data-lucide="search"></i>
                    <input type="text" placeholder="Search products..." oninput="app.searchProducts(this.value)"
                        aria-label="Search">
                </div>
            </div>

            <!-- Categories Chips -->
            <div class="chip-container">
                <button class="chip active" onclick="app.filter('All', this)">All</button>
                <button class="chip" onclick="app.router('deals')"><i data-lucide="zap" size="14"
                        style="margin-right:6px"></i>Deals</button>
                <button class="chip" onclick="app.filter('Electronics', this)">Electronics</button>
                <button class="chip" onclick="app.filter('Fashion', this)">Fashion</button>
                <button class="chip" onclick="app.filter('Home', this)">Home</button>
                <button class="chip" onclick="app.filter('Art', this)">Art</button>
            </div>

            <div class="grid" id="product-grid">
                <!-- Products -->
            </div>
        </div>

        <!-- DETAILS -->
        <div id="view-detail" class="view">
            <button class="btn btn-ghost" onclick="app.router('home')" style="margin-bottom: 24px"><i
                    data-lucide="arrow-left" style="margin-right:8px"></i> Back</button>
            <div id="detail-content"></div>
        </div>

        <!-- WISHLIST -->
        <div id="view-wishlist" class="view">
            <h2 style="margin-bottom: 24px">Wishlist</h2>
            <div class="grid" id="wishlist-grid"></div>
        </div>

        <!-- ORDERS -->
        <div id="view-orders" class="view">
            <h2 style="margin-bottom: 24px">Order History</h2>
            <div id="order-list" style="display: flex; flex-direction: column; gap: 16px;"></div>
        </div>

        <!-- DEALS -->
        <div id="view-deals" class="view">
            <button class="btn btn-ghost" onclick="app.router('home')" style="margin-bottom:24px"><i
                    data-lucide="arrow-left" style="margin-right:8px"></i> Back</button>
            <h2 style="margin-bottom: 24px; color: var(--md-sys-color-tertiary)">Hot Deals ðŸ”¥</h2>
            <div class="grid" id="deals-grid"></div>
        </div>

        <!-- CATEGORIES -->
        <div id="view-categories" class="view">
            <h2 style="margin-bottom: 24px;">Browse Categories</h2>
            <div class="grid">
                <div class="card-panel p-4 text-center cursor-pointer" onclick="app.filterAndGoHome('Electronics')">
                    <i data-lucide="smartphone" size="32" class="mb-2 mx-auto text-primary"></i>
                    <h3>Electronics</h3>
                </div>
                <div class="card-panel p-4 text-center cursor-pointer" onclick="app.filterAndGoHome('Fashion')">
                    <i data-lucide="shirt" size="32" class="mb-2 mx-auto text-primary"></i>
                    <h3>Fashion</h3>
                </div>
                <div class="card-panel p-4 text-center cursor-pointer" onclick="app.filterAndGoHome('Home')">
                    <i data-lucide="home" size="32" class="mb-2 mx-auto text-primary"></i>
                    <h3>Home</h3>
                </div>
                <div class="card-panel p-4 text-center cursor-pointer" onclick="app.filterAndGoHome('Art')">
                    <i data-lucide="palette" size="32" class="mb-2 mx-auto text-primary"></i>
                    <h3>Art</h3>
                </div>
            </div>
        </div>

        <!-- ADDRESS BOOK -->
        <div id="view-address" class="view">
            <div style="display:flex; justify-content:space-between; margin-bottom:24px">
                <h2>Address Book</h2>
                <button class="btn btn-primary btn-sm" onclick="app.openAddressModal()">Add New</button>
            </div>
            <div id="address-list" class="grid"></div>
        </div>

        <!-- COUPONS -->
        <div id="view-coupons" class="view">
            <h2 style="margin-bottom: 24px">My Coupons</h2>
            <div class="grid">
                <div class="card-panel" style="padding: 24px; border-left: 4px solid var(--md-sys-color-primary);">
                    <h3 style="font-size: 20px;">WELCOME20</h3>
                    <p style="color: var(--md-sys-color-secondary);">20% OFF first order</p>
                    <button class="btn btn-ghost btn-sm" style="margin-top: 12px"
                        onclick="app.copyCode('WELCOME20')">Copy Code</button>
                </div>
                <div class="card-panel" style="padding: 24px; border-left: 4px solid var(--md-sys-color-tertiary);">
                    <h3 style="font-size: 20px;">SAVE10</h3>
                    <p style="color: var(--md-sys-color-secondary);">$10 OFF orders over $50</p>
                    <button class="btn btn-ghost btn-sm" style="margin-top: 12px" onclick="app.copyCode('SAVE10')">Copy
                        Code</button>
                </div>
            </div>
        </div>

        <!-- ACCOUNT -->
        <div id="view-account" class="view">
            <div style="text-align: center; margin-bottom: 40px;">
                <div id="profile-display"></div>
            </div>
            <div class="grid" style="max-width: 600px; margin: 0 auto; gap: 12px;">
                <button class="btn btn-secondary" style="justify-content: flex-start; height: 56px;"
                    onclick="app.router('orders')">
                    <i data-lucide="package" style="margin-right: 12px"></i> Orders
                </button>
                <button class="btn btn-secondary" style="justify-content: flex-start; height: 56px;"
                    onclick="app.router('wishlist')">
                    <i data-lucide="heart" style="margin-right: 12px"></i> Wishlist
                </button>
                <button class="btn btn-secondary" style="justify-content: flex-start; height: 56px;"
                    onclick="app.router('address')">
                    <i data-lucide="map-pin" style="margin-right: 12px"></i> Addresses
                </button>
                <button class="btn btn-secondary" style="justify-content: flex-start; height: 56px;"
                    onclick="app.router('coupons')">
                    <i data-lucide="tag" style="margin-right: 12px"></i> Coupons
                </button>
                <button class="btn btn-secondary" style="justify-content: flex-start; height: 56px;"
                    onclick="app.router('settings')">
                    <i data-lucide="settings" style="margin-right: 12px"></i> Settings
                </button>
                <button class="btn btn-secondary" style="justify-content: flex-start; height: 56px;"
                    onclick="app.toggleTheme()">
                    <i data-lucide="moon" style="margin-right: 12px"></i> Toggle Dark Mode
                </button>
                <button class="btn btn-primary"
                    style="background-color: var(--md-sys-color-error); color: var(--md-sys-color-on-error); margin-top: 20px;"
                    onclick="app.logout()">
                    Sign Out
                </button>
            </div>
        </div>

        <!-- SETTINGS -->
        <div id="view-settings" class="view">
            <button class="btn btn-ghost" onclick="app.router('account')" style="margin-bottom: 20px;"><i
                    data-lucide="arrow-left"></i> Back</button>
            <h1 style="margin-bottom: 40px;">Settings</h1>
            <div class="card-panel" style="padding: 24px 0; overflow: hidden;">
                <div style="background-color: var(--md-sys-color-surface-variant); padding: 24px; margin-top: 10px;">
                    <h3 style="margin-bottom: 16px; font-size: 18px;">Edit Profile</h3>
                    <input type="text" placeholder="Update Display Name" id="settings-name"
                        style="margin-bottom: 16px;">
                    <button class="btn btn-primary btn-sm" onclick="app.updateProfileName()">Save Changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Admin FAB -->
    <div class="fab-main" id="admin-fab" style="display: none;" onclick="app.openAdmin()">
        <i data-lucide="plus"></i>
    </div>

    <!-- MOBILE BOTTOM NAVIGATION (New Requirement) -->
    <div class="bottom-nav">
        <!-- Floating Center Button (Shopping) -->
        <div class="nav-fab-shopping" onclick="app.toggleCart()">
            <i data-lucide="shopping-bag" style="width:28px; height:28px; color:white"></i>
        </div>

        <div class="bottom-nav-bar">
            <!-- Left -->
            <div class="nav-item active" onclick="app.router('home')" id="nav-home">
                <i data-lucide="home"></i>
                <span>Home</span>
            </div>
            <div class="nav-item" onclick="app.router('categories')" id="nav-cat">
                <i data-lucide="layout-grid"></i>
                <span>Category</span>
            </div>

            <!-- Spacer for Center Button -->
            <div class="nav-center-wrapper"></div>

            <!-- Right -->
            <div class="nav-item" onclick="app.router('account')" id="nav-account">
                <i data-lucide="user"></i>
                <span>Account</span>
            </div>
            <div class="nav-item" onclick="app.router('settings')" id="nav-set">
                <i data-lucide="settings"></i>
                <span>Setting</span>
            </div>
        </div>
    </div>

    <!-- Cart Drawer -->
    <div class="drawer" id="cart-drawer">
        <div class="drawer-header">
            <span>Shopping Bag</span>
            <button class="btn btn-icon btn-ghost" onclick="app.toggleCart()"><i data-lucide="x"></i></button>
        </div>
        <div class="drawer-content" id="cart-items"></div>
        <div class="drawer-footer">
            <div class="coupon-section">
                <input type="text" id="promo-code" placeholder="Promo Code">
                <button class="btn btn-secondary btn-sm" onclick="app.applyPromo()">Apply</button>
            </div>
            <div
                style="display: flex; justify-content: space-between; margin-bottom: 24px; font-weight: 700; font-size: 20px;">
                <span>Total</span>
                <span id="cart-total">$0.00</span>
            </div>
            <button class="btn btn-primary" style="width: 100%; height: 48px;"
                onclick="app.checkout()">Checkout</button>
        </div>
    </div>

    <!-- Auth Dialog -->
    <div class="dialog-scrim" id="auth-dialog">
        <div class="dialog">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <h2 style="font-size: 24px;">Sign In</h2>
                <button class="btn btn-icon btn-ghost" onclick="app.closeModal('auth-dialog')"><i
                        data-lucide="x"></i></button>
            </div>
            <div style="margin-bottom: 20px;">
                <button class="btn btn-secondary" style="width:100%; margin-bottom: 12px;" onclick="app.googleLogin()">
                    Sign in with Google
                </button>
                <div style="text-align: center; margin: 10px 0; color: var(--md-sys-color-outline);">OR</div>
            </div>
            <form onsubmit="app.emailLogin(event)">
                <input type="email" id="auth-email" placeholder="Email" required style="margin-bottom: 12px;">
                <input type="password" id="auth-pass" placeholder="Password" required style="margin-bottom: 24px;">
                <button type="submit" class="btn btn-primary" style="width: 100%;">Continue</button>
            </form>
        </div>
    </div>

    <!-- Admin Dialog -->
    <div class="dialog-scrim" id="admin-dialog">
        <div class="dialog">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <h2>Add Product</h2>
                <button class="btn btn-icon btn-ghost" onclick="app.closeModal('admin-dialog')"><i
                        data-lucide="x"></i></button>
            </div>
            <form onsubmit="app.uploadProduct(event)">
                <input type="text" id="p-name" placeholder="Name" required style="margin-bottom:12px;">
                <input type="text" id="p-cat" placeholder="Category" required style="margin-bottom:12px;">
                <input type="number" id="p-price" placeholder="Price" required style="margin-bottom:12px;">
                <textarea id="p-desc" placeholder="Description" rows="3" style="margin-bottom:12px;"></textarea>
                <input type="text" id="p-img" placeholder="Image URL (Unsplash)" required style="margin-bottom:24px;">
                <button type="submit" class="btn btn-primary" style="width: 100%;">Upload</button>
            </form>
        </div>
    </div>

    <!-- Address Dialog -->
    <div class="dialog-scrim" id="address-dialog">
        <div class="dialog">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
                <h2>Add Address</h2>
                <button class="btn btn-icon btn-ghost" onclick="app.closeModal('address-dialog')"><i
                        data-lucide="x"></i></button>
            </div>
            <form onsubmit="app.addAddress(event)">
                <input type="text" id="addr-name" placeholder="Full Name" required style="margin-bottom:12px;">
                <input type="text" id="addr-line" placeholder="Street Address" required style="margin-bottom:12px;">
                <div style="display:flex; gap:12px; margin-bottom:24px;">
                    <input type="text" id="addr-city" placeholder="City" required>
                    <input type="text" id="addr-zip" placeholder="ZIP" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">Save</button>
            </form>
        </div>
    </div>

    <!-- Snackbar -->
    <div id="snackbar" class="snackbar">
        <span id="sb-msg">Message</span>
        <button class="btn btn-ghost btn-sm" style="color: #d0bcff;"
            onclick="document.getElementById('snackbar').style.display='none'">Dismiss</button>
    </div>

    <!-- Logic -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, signInWithEmailAndPassword, createUserWithEmailAndPassword, onAuthStateChanged, signOut, signInAnonymously, signInWithCustomToken, updateProfile } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, serverTimestamp, query, orderBy, doc, getDoc, setDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // CONFIG
         // Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCsp-xvRknmdBFuS39V0IsljDIq3bOLGOA",
            authDomain: "portfolio-app-b908d.firebaseapp.com",
            projectId: "portfolio-app-b908d",
            storageBucket: "portfolio-app-b908d.firebasestorage.app",
            messagingSenderId: "1036721930214",
            appId: "1:1036721930214:web:3cd553be7488a6a7ec2027",
            measurementId: "G-MWFJTKSHY7"
        };

        // Admin credentials for production
        const ADMIN_EMAIL = "joykumbhakar101@gmail.com";
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'realstore-prod';

        const app_fb = initializeApp(firebaseConfig);
        const auth = getAuth(app_fb);
        const db = getFirestore(app_fb);

        let user = null;
        let products = [];
        let cart = [];
        let wishlist = [];
        let addresses = [];
        let discount = 0;

        window.app = {
            init: async () => {
                lucide.createIcons();
                // Rule 3: Auth First - Ensure user is authenticated before any DB Ops
                try {
                    if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
                        await signInWithCustomToken(auth, __initial_auth_token);
                    } else if (!auth.currentUser) {
                        // Anonymous fallback for guests to enable DB access (Production Requirement)
                        await signInAnonymously(auth);
                    }
                } catch (e) { console.error("Auth Error:", e); }

                onAuthStateChanged(auth, async (u) => {
                    user = u;
                    const btn = document.getElementById('auth-btn-desktop');
                    if (u && !u.isAnonymous) {
                        // Logged in user
                        if (btn) {
                            btn.innerHTML = `<img src="${u.photoURL || 'https://ui-avatars.com/api/?name=' + u.email + '&background=0b57d0&color=fff'}" style="width:32px;height:32px;border-radius:50%">`;
                            btn.onclick = () => app.router('account');
                        }
                        document.getElementById('admin-fab').style.display = 'flex';
                        app.loadUserData();
                    } else {
                        // Guest (Anonymous)
                        if (btn) {
                            btn.innerHTML = '<i data-lucide="user"></i>';
                            btn.onclick = () => app.openAuth();
                        }
                        document.getElementById('admin-fab').style.display = 'none';
                        // Keep cart local or fetch anonymous cart if implementing complex logic
                        // For this demo, reset user-specific data on logout/guest
                        if (!u) { cart = []; wishlist = []; addresses = []; }
                        app.renderCart();
                    }

                    // Fetch products after auth is confirmed
                    if (products.length === 0) app.fetchProducts();
                });
            },

            // --- NAVIGATION ---
            router: (v) => {
                document.querySelectorAll('.view').forEach(el => el.classList.remove('active'));
                const target = document.getElementById(`view-${v}`);
                if (target) target.classList.add('active');
                window.scrollTo(0, 0);

                // Update Bottom Nav Active State
                document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
                const navIdMap = { 'home': 'nav-home', 'categories': 'nav-cat', 'account': 'nav-account', 'settings': 'nav-set' };
                if (navIdMap[v]) document.getElementById(navIdMap[v]).classList.add('active');

                // View specific loaders
                if (v === 'account') app.renderAccount();
                if (v === 'orders') app.loadOrders();
                if (v === 'wishlist') app.renderWishlist();
                if (v === 'address') app.loadAddresses();
                if (v === 'deals') app.loadDeals();
            },

            toggleCart: () => document.getElementById('cart-drawer').classList.toggle('open'),
            openAuth: () => document.getElementById('auth-dialog').classList.add('open'),
            openAdmin: () => document.getElementById('admin-dialog').classList.add('open'),
            openAddressModal: () => document.getElementById('address-dialog').classList.add('open'),
            closeModal: (id) => document.getElementById(id).classList.remove('open'),
            closeThankYou: () => {
                document.getElementById('thank-you-overlay').classList.remove('active');
                app.router('orders');
            },

            // --- DATA ---
            fetchProducts: async () => {
                const grid = document.getElementById('product-grid');
                grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;padding:40px"><div class="loader" style="margin:0 auto"></div></div>';
                try {
                    // Rule 1 & 2: Strict Path, Simple Query
                    const colRef = collection(db, 'artifacts', appId, 'public', 'data', 'products');
                    // Sorting in memory for small datasets to avoid index errors in demo
                    const snap = await getDocs(colRef);
                    products = [];
                    snap.forEach(d => products.push({ id: d.id, ...d.data() }));
                    // Sort descending by creation
                    products.sort((a, b) => (b.createdAt?.seconds || 0) - (a.createdAt?.seconds || 0));
                    app.renderProducts(products);
                } catch (e) {
                    console.error(e);
                    grid.innerHTML = '<p style="text-align:center;grid-column:1/-1">Unable to load products. Check connection.</p>';
                }
            },

            renderProducts: (list) => {
                const grid = document.getElementById('product-grid');
                if (list.length === 0) { grid.innerHTML = '<p style="text-align:center;grid-column:1/-1">No items found.</p>'; return; }

                grid.innerHTML = list.map(p => `
                    <div class="product-card" onclick='app.showDetail(${JSON.stringify(p).replace(/'/g, "&#39;")})'>
                        <div class="img-box"><img src="${p.image}" loading="lazy" alt="${p.name}">
                            <button class="fab-mini" onclick='event.stopPropagation(); app.addToCart(${JSON.stringify(p).replace(/'/g, "&#39;")})' aria-label="Add to cart"><i data-lucide="plus"></i></button>
                        </div>
                        <div class="info-box">
                            <div class="p-cat">${p.category || 'General'}</div>
                            <div class="p-title">${p.name}</div>
                            <div class="p-price">$${p.price}</div>
                        </div>
                    </div>
                `).join('');
                lucide.createIcons();
            },

            showDetail: (p) => {
                const container = document.getElementById('detail-content');
                container.innerHTML = `
                    <div class="detail-layout">
                        <img src="${p.image}" class="detail-img">
                        <div class="detail-info">
                            <div style="font-size:14px;color:var(--md-sys-color-primary);font-weight:700;margin-bottom:8px;text-transform:uppercase">${p.category || 'ITEM'}</div>
                            <h1>${p.name}</h1>
                            <div class="detail-price">$${p.price}</div>
                            <p style="line-height:1.6;color:var(--md-sys-color-on-surface-variant);margin-bottom:32px">${p.description}</p>
                            <div style="display:flex;gap:12px">
                                <button class="btn btn-primary btn-lg" style="flex:1" onclick='app.addToCart(${JSON.stringify(p).replace(/'/g, "&#39;")})'>Add to Cart</button>
                                <button class="btn btn-secondary btn-lg" onclick='app.toggleWishlist(${JSON.stringify(p).replace(/'/g, "&#39;")})' aria-label="Add to wishlist"><i data-lucide="heart"></i></button>
                            </div>
                        </div>
                    </div>`;
                app.router('detail');
                lucide.createIcons();
            },

            loadDeals: () => {
                const deals = products.filter(p => p.price < 50); // Simple logic for demo
                const grid = document.getElementById('deals-grid');
                if (deals.length === 0) grid.innerHTML = '<p class="text-center">No hot deals right now.</p>';
                else {
                    // Reuse render logic but into a different container
                    grid.innerHTML = deals.map(p => `
                        <div class="product-card" onclick='app.showDetail(${JSON.stringify(p).replace(/'/g, "&#39;")})'>
                            <div class="img-box"><img src="${p.image}" loading="lazy"><span style="position:absolute;top:10px;right:10px;background:#e53935;color:white;padding:4px 8px;border-radius:4px;font-size:12px;font-weight:bold">HOT</span></div>
                            <div class="info-box"><div class="p-title">${p.name}</div><div class="p-price text-danger">$${p.price}</div></div>
                        </div>
                     `).join('');
                    lucide.createIcons();
                }
            },

            filterAndGoHome: (cat) => {
                app.router('home');
                app.filter(cat, document.querySelector(`.chip:contains(${cat})`) || document.querySelector('.chip')); // Basic selection
                app.toast(`Filtering ${cat}...`);
            },

            // --- CART & WISHLIST (Optimistic UI + Firestore Sync) ---
            addToCart: (p) => {
                cart.push(p);
                app.renderCart();
                app.toast(`Added ${p.name}`);
                document.getElementById('cart-drawer').classList.add('open');
                app.syncCart(); // Background sync
            },
            removeFromCart: (i) => { cart.splice(i, 1); app.renderCart(); app.syncCart(); },

            syncCart: async () => {
                if (!user || user.isAnonymous) return; // Optional: Sync anonymous if desired, but rules might restrict
                // Rule 1: /artifacts/{appId}/users/{userId}/cart
                // Storing as a single document for simplicity in this demo to avoid subcollection complexity
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'cart'), { items: cart });
                } catch (e) { console.error("Sync error", e); }
            },

            renderCart: () => {
                const el = document.getElementById('cart-items');
                const badge = document.getElementById('cart-badge-desktop'); // Desktop
                if (badge) badge.style.display = cart.length ? 'block' : 'none';

                let sub = 0;
                el.innerHTML = cart.length ? cart.map((p, i) => {
                    sub += parseFloat(p.price);
                    return `
                    <div class="cart-item" style="display:flex;gap:16px;align-items:center;">
                        <img src="${p.image}" style="width:64px;height:64px;border-radius:8px;object-fit:cover;">
                        <div style="flex:1">
                            <div style="font-weight:500">${p.name}</div>
                            <div style="color:var(--md-sys-color-outline)">$${p.price}</div>
                        </div>
                        <button class="btn-icon" onclick="app.removeFromCart(${i})" aria-label="Remove"><i data-lucide="trash-2" style="width:18px"></i></button>
                    </div>`;
                }).join('') : '<p style="text-align:center;margin-top:40px;color:var(--md-sys-color-outline)">Cart is empty</p>';

                let total = discount > 0 ? (discount < 1 ? sub * (1 - discount) : Math.max(0, sub - discount)) : sub;
                document.getElementById('cart-total').innerText = '$' + total.toFixed(2);
                lucide.createIcons();
            },

            applyPromo: () => {
                const code = document.getElementById('promo-code').value.toUpperCase();
                if (code === 'WELCOME20') { discount = 0.2; app.toast("20% Applied!"); }
                else if (code === 'SAVE10') { discount = 10; app.toast("$10 Applied!"); }
                else { app.toast("Invalid Code"); discount = 0; }
                app.renderCart();
            },

            toggleWishlist: (p) => {
                const idx = wishlist.findIndex(w => w.id === p.id);
                if (idx === -1) { wishlist.push(p); app.toast("Saved to Wishlist"); }
                else { wishlist.splice(idx, 1); app.toast("Removed from Wishlist"); }
                if (document.getElementById('view-wishlist').classList.contains('active')) app.renderWishlist();
                app.syncWishlist();
            },

            syncWishlist: async () => {
                if (!user || user.isAnonymous) return;
                try {
                    await setDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'wishlist'), { items: wishlist });
                } catch (e) { console.error(e); }
            },

            renderWishlist: () => {
                const el = document.getElementById('wishlist-grid');
                if (!wishlist.length) { el.innerHTML = '<p style="grid-column:1/-1;text-align:center">No saved items.</p>'; return; }
                el.innerHTML = wishlist.map(p => `
                    <div class="product-card" style="display:flex;align-items:center;padding:16px;gap:16px">
                        <img src="${p.image}" style="width:80px;height:80px;border-radius:12px;object-fit:cover">
                        <div style="flex:1">
                            <div style="font-weight:500">${p.name}</div>
                            <div>$${p.price}</div>
                        </div>
                        <button class="btn btn-primary btn-sm" onclick='app.addToCart(${JSON.stringify(p).replace(/'/g, "&#39;")})'>Buy</button>
                    </div>
                `).join('');
            },

            // --- ACCOUNT & USER ---
            loadUserData: async () => {
                if (!user || user.isAnonymous) return;
                // Rule 1 Compliance: /artifacts/{appId}/users/{userId}/data/{docId}
                try {
                    const cartDoc = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'cart'));
                    if (cartDoc.exists()) { cart = cartDoc.data().items || []; app.renderCart(); }

                    const wishDoc = await getDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'data', 'wishlist'));
                    if (wishDoc.exists()) wishlist = wishDoc.data().items || [];
                } catch (e) { console.error("Load user data error", e); }
            },

            renderAccount: () => {
                if (!user) return app.router('home');
                const isGuest = user.isAnonymous;
                document.getElementById('profile-display').innerHTML = `
                    <img src="${user.photoURL || 'https://ui-avatars.com/api/?name=' + (isGuest ? 'Guest' : 'User')}" style="width:96px;height:96px;border-radius:50%;margin-bottom:16px">
                    <h2 style="font-size:22px">${isGuest ? 'Guest User' : (user.displayName || 'User')}</h2>
                    <p style="color:var(--md-sys-color-outline)">${isGuest ? 'Sign up to save data' : user.email}</p>
                `;
            },

            updateProfileName: async () => {
                const name = document.getElementById('settings-name').value;
                if (!name || !user) return;
                try {
                    await updateProfile(user, { displayName: name });
                    app.toast("Profile updated");
                    app.renderAccount();
                } catch (e) { alert(e.message); }
            },

            // --- ADDRESS BOOK ---
            loadAddresses: async () => {
                const list = document.getElementById('address-list');
                list.innerHTML = '<div class="loader" style="margin:0 auto"></div>';
                if (!user || user.isAnonymous) { list.innerHTML = '<p class="text-center">Login required.</p>'; return; }

                try {
                    const q = collection(db, 'artifacts', appId, 'users', user.uid, 'addresses');
                    const snap = await getDocs(q);
                    addresses = [];
                    snap.forEach(d => addresses.push({ id: d.id, ...d.data() }));

                    list.innerHTML = addresses.length ? addresses.map(a => `
                        <div class="card-panel" style="padding:20px;position:relative">
                            <div style="font-weight:700;margin-bottom:4px">${a.name}</div>
                            <div style="color:var(--md-sys-color-on-surface-variant)">${a.line}, ${a.city} ${a.zip}</div>
                            <button class="btn-icon btn-ghost" style="position:absolute;top:10px;right:10px" onclick="app.deleteAddress('${a.id}')"><i data-lucide="trash-2" style="width:16px"></i></button>
                        </div>
                    `).join('') : '<p class="text-center">No addresses found.</p>';
                    lucide.createIcons();
                } catch (e) { console.error(e); }
            },

            addAddress: async (e) => {
                e.preventDefault();
                if (!user || user.isAnonymous) return alert("Please sign in");
                const name = document.getElementById('addr-name').value;
                const line = document.getElementById('addr-line').value;

                if (!name || !line) return app.toast("Fill required fields");

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'addresses'), {
                        name: name,
                        line: line,
                        city: document.getElementById('addr-city').value,
                        zip: document.getElementById('addr-zip').value,
                        createdAt: serverTimestamp()
                    });
                    app.closeModal('address-dialog');
                    e.target.reset();
                    app.loadAddresses();
                    app.toast("Address Added");
                } catch (err) { alert(err.message); }
            },

            deleteAddress: async (id) => {
                if (!confirm("Delete address?")) return;
                try {
                    await deleteDoc(doc(db, 'artifacts', appId, 'users', user.uid, 'addresses', id));
                    app.loadAddresses();
                    app.toast("Address Deleted");
                } catch (e) { app.toast("Error deleting"); }
            },

            // --- ADMIN UPLOAD ---
            uploadProduct: async (e) => {
                e.preventDefault();
                // Simple client-side check, robust check is via Firestore Rules
                // if(!user || user.email !== 'admin@example.com') return alert("Admins only"); 

                const btn = e.target.querySelector('button');
                const loader = btn.querySelector('.loader');

                if (!user) return alert("Login first");

                btn.disabled = true;
                btn.querySelector('span').style.display = "none";
                loader.style.display = "inline-block";

                try {
                    await addDoc(collection(db, 'artifacts', appId, 'public', 'data', 'products'), {
                        name: document.getElementById('p-name').value,
                        category: document.getElementById('p-cat').value,
                        price: parseFloat(document.getElementById('p-price').value),
                        description: document.getElementById('p-desc').value,
                        image: document.getElementById('p-img').value,
                        createdAt: serverTimestamp()
                    });
                    app.closeModal('admin-dialog');
                    e.target.reset();
                    app.fetchProducts();
                    app.toast("Product Uploaded");
                } catch (err) { alert(err.message); }
                finally {
                    btn.disabled = false;
                    btn.querySelector('span').style.display = "inline";
                    loader.style.display = "none";
                }
            },

            // --- HELPERS ---
            toast: (msg) => {
                const sb = document.getElementById('snackbar');
                document.getElementById('sb-msg').innerText = msg;
                sb.style.display = 'flex';
                // Trigger reflow for animation
                void sb.offsetWidth;
                setTimeout(() => sb.style.display = 'none', 3000);
            },
            copyCode: (c) => { navigator.clipboard.writeText(c); app.toast("Copied " + c); },
            toggleTheme: () => { document.body.classList.toggle('dark-mode'); localStorage.setItem('darkMode', document.body.classList.contains('dark-mode')); },
            googleLogin: async () => { try { await signInWithPopup(auth, new GoogleAuthProvider()); app.closeModal('auth-dialog'); } catch (e) { console.error(e) } },
            emailLogin: async (e) => {
                e.preventDefault();
                const em = document.getElementById('auth-email').value;
                const pw = document.getElementById('auth-pass').value;
                try { await signInWithEmailAndPassword(auth, em, pw); app.closeModal('auth-dialog'); }
                catch { try { await createUserWithEmailAndPassword(auth, em, pw); app.closeModal('auth-dialog'); } catch (er) { alert(er.message); } }
            },
            logout: () => signOut(auth),
            filter: (cat, el) => {
                document.querySelectorAll('.chip').forEach(c => c.classList.remove('active'));
                el.classList.add('active');
                if (cat === 'All') app.renderProducts(products);
                else app.renderProducts(products.filter(p => (p.category || '').toLowerCase() === cat.toLowerCase()));
            },
            searchProducts: (val) => {
                const term = val.toLowerCase();
                app.renderProducts(products.filter(p => p.name.toLowerCase().includes(term)));
            },

            // --- ORDER MANAGEMENT ---
            loadOrders: async () => {
                const list = document.getElementById('order-list');
                list.innerHTML = '<div class="loader" style="margin:0 auto"></div>';

                if (!user || user.isAnonymous) {
                    list.innerHTML = '<p class="text-center">Please log in to view orders.</p>';
                    return;
                }

                try {
                    const q = query(collection(db, 'artifacts', appId, 'users', user.uid, 'orders'), orderBy('date', 'desc'));
                    const snap = await getDocs(q);

                    if (snap.empty) {
                        list.innerHTML = '<div class="card-panel" style="padding:20px;text-align:center">No past orders found.</div>';
                    } else {
                        list.innerHTML = snap.docs.map(doc => {
                            const order = doc.data();
                            const date = order.date ? new Date(order.date.seconds * 1000).toLocaleDateString() : 'Just now';
                            // Mock tracking status progression based on time
                            const statuses = ['Ordered', 'Shipped', 'Out for Delivery', 'Delivered'];
                            // For demo, just show all steps

                            return `
                                <div class="card-panel" style="padding:20px; margin-bottom: 20px;">
                                    <div style="display:flex; justify-content:space-between; margin-bottom:15px; border-bottom:1px solid var(--md-sys-color-outline-variant); padding-bottom:10px;">
                                        <div><strong>Order #${doc.id.slice(0, 8).toUpperCase()}</strong></div>
                                        <div style="color:var(--md-sys-color-primary)">${date}</div>
                                    </div>
                                    <div class="tracking-timeline">
                                        <div class="tracking-step active">
                                            <div class="step-dot"></div>
                                            <div class="step-label">Ordered</div>
                                        </div>
                                        <div class="tracking-step active">
                                            <div class="step-dot"></div>
                                            <div class="step-label">Shipped</div>
                                        </div>
                                        <div class="tracking-step active">
                                            <div class="step-dot"></div>
                                            <div class="step-label">Out for Delivery</div>
                                        </div>
                                        <div class="tracking-step">
                                            <div class="step-dot"></div>
                                            <div class="step-label">Delivered</div>
                                        </div>
                                    </div>
                                    <div style="margin-top:15px; font-weight:bold; text-align:right">
                                        Total: $${order.total}
                                    </div>
                                </div>
                            `;
                        }).join('');
                    }
                } catch (e) {
                    console.error("Error loading orders:", e);
                    list.innerHTML = '<p class="text-center">Error loading orders.</p>';
                }
            },

            checkout: async () => {
                if (!cart.length) return app.toast("Cart is empty");
                if (!user) return app.openAuth();

                // Simulate Payment Processing
                const btn = document.querySelector('.drawer-footer .btn-primary');
                const originalText = btn.innerText;
                btn.innerText = "Processing...";
                btn.disabled = true;

                try {
                    // 1. Create Order in Firestore
                    const orderData = {
                        items: cart,
                        total: document.getElementById('cart-total').innerText.replace('$', ''),
                        date: serverTimestamp(),
                        status: 'Ordered'
                    };

                    if (!user.isAnonymous) {
                        await addDoc(collection(db, 'artifacts', appId, 'users', user.uid, 'orders'), orderData);
                    }

                    // 2. Clear Cart
                    cart = [];
                    await app.syncCart();
                    app.renderCart();
                    app.toggleCart();

                    // 3. Show Success Animation Overlay
                    const overlay = document.getElementById('thank-you-overlay');
                    overlay.classList.add('active');

                } catch (error) {
                    console.error("Checkout failed:", error);
                    app.toast("Checkout failed. Please try again.");
                } finally {
                    btn.innerText = originalText;
                    btn.disabled = false;
                }
            }
        };

        app.init();
    </script>
</body>

</html>
